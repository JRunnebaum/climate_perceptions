---
title: "evaluation_by_fishery"
author: "Jocelyn Runnebaum"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  word_document:
    reference_docx: word-styles-reference.docx
---
#This is a preliminary exploration of responses by fishery type. I want to explore relationships between demographics and beliefs about climate change using crosstabulations. "Survey Reseach and Analysis" by Vaske, Ch 13 has been helpful so far is understanding the best way to approach this. This website on how to do crosstabulations in R using dplyr is also helpful: http://analyticswithr.com/contingencytables.html
```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(likert)
library(gridExtra)
# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```

```{r data}
responses <- read.csv("../data/PNW_decoded_responses_wstate13.May.2021.csv")
```

#tibble for each fishery
```{r}

cpsfishers<- responses%>%
  filter(CPS == 1)

dcfishers<- responses%>%
  filter(dungeness_crab == 1)

gffishers<- responses%>%
  filter(groundfish == 1)

hakefishers<- responses%>%
  filter(hake == 1)

hmsfishers<- responses%>%
  filter(HMS == 1)

salmonfishers<- responses%>%
  filter(salmon == 1)

scallopfishers<- responses%>%
  filter(scallops == 1)

squidfishers<- responses%>%
  filter(squid == 1)

urchinfishers <- responses %>% 
  filter(urchin == 1)

otherfishers <- responses %>%
  filter(other == 1)

```

##components of vulnerability for a few fisheries
```{r}

#add a column to specify which fishery they're in
dcfishers$fishery = "dungycrab"
salmonfishers$fishery = "salmon"
gffishers$fishery = "groundfish"
hmsfishers$fishery = "hms"
cpsfishers$fishery = "cps"
urchinfishers$fishery = "urchin"
otherfishers$fishery = "other"


#select just the components of vulnerability
dcfishersvuln <- dcfishers %>%
  select(fishery,indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)
salmonfishersvuln <- salmonfishers %>%
  select(fishery,indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)
gffishersvuln <- gffishers %>%
  select(fishery,indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)
hmsfishersvuln <- hmsfishers %>%
  select(fishery,indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)
urchinfishersvuln <- urchinfishers %>%
  select(fishery,indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)
otherfishersvuln <- otherfishers %>%
  select(fishery,indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)

#combine to make one table of fishers and components of vulnerability
fishers_vuln <- full_join(dcfishersvuln, salmonfishersvuln)
fishers_vuln <- full_join(fishers_vuln, gffishersvuln)
fishers_vuln <- full_join(fishers_vuln, hmsfishersvuln)
fishers_vuln <- full_join(fishers_vuln, urchinfishersvuln)
fishers_vuln <- full_join(fishers_vuln, otherfishersvuln)
```

##looking at components of vulnerability
```{r}

#summary of all components
fishers_vuln %>%
  group_by(fishery) %>%
  dplyr::summarise(meanex = mean(indv_exposure, na.rm = TRUE),
                   meanac = mean(indv_ac, na.rm = TRUE),
                   meansen = mean(indv_sensitivity, na.rm = TRUE),
                   meanvuln = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n())

#num_fisheries_ac_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_ac",
          #color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          #order = c("1", "2", "3", "4+"),
          #ylab = "adaptive capacity", xlab = "number of fisheries participated in")

#num_fisheries_ac_range

#ggsave(plot = num_fisheries_ac_range, file = paste0("../figures/vulnerability/numfisheries_ac.png"))

#anova exposure
fishersex_aov<-aov(indv_exposure ~ fishery, data = fishers_vuln)
summary(fishersex_aov)
#nothing

#anova sensitivity
fisherssen_aov<-aov(indv_sensitivity ~ fishery, data = fishers_vuln)
summary(fisherssen_aov)

#anova adaptive capacity
fishersac_aov<-aov(indv_ac ~ fishery, data = fishers_vuln)
summary(fishersac_aov)

#anova vulnerability
fishersvuln_aov<-aov(indv_vulnerability_euc ~ fishery, data = fishers_vuln)
summary(fishersvuln_aov)

#shows jackshit nothingness
```
#ridgeline plot of components of vulnerability by fishery
```{r}
#install.packages("ggridges")
library(ggridges)
library(viridis)
library(hrbrthemes)


ggplot(fishers_vuln, aes(x = indv_vulnerability_euc, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_manual(values = pal4) + 
  theme(legend.position = "none")

ggplot(fishers_vuln, aes(x = indv_exposure, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  scale_fill_viridis(name = "indv_exposure", option = "C") +
  labs(title = 'exposure by fishery') +
  theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

v<-ggplot(fishers_vuln, aes(x = indv_vulnerability_euc, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  scale_fill_viridis(name = "indv_vulnerability_euc", option = "C") +
  labs(title = 'vulnerability') +
  theme_ipsum() +
    theme(plot.title = element_text(size = 8),
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

s<-ggplot(fishers_vuln, aes(x = indv_sensitivity, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  scale_fill_viridis(name = "indv_sensitivity", option = "C") +
  labs(title = 'sensitivity') +
  theme_ipsum() +
    theme(plot.title = element_text(size = 8),
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

a<-ggplot(fishers_vuln, aes(x = indv_ac, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  scale_fill_viridis(name = "indv_ac", option = "C") +
  labs(title = 'adaptive capacity') +
  theme_ipsum() +
    theme(plot.title = element_text(size = 8),
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

e<-ggplot(fishers_vuln, aes(x = indv_exposure, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  scale_fill_viridis(name = "indv_exposure", option = "C") +
  labs(title = 'exposure') +
  theme_ipsum() +
    theme(plot.title = element_text(size = 8),
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

vr<-grid.arrange(e, s, a, v, nrow = 2)

e

ggsave(plot = vr, height = 7, width = 7, file = paste0("../figures/vulnerability/fishery_vuln_ranges.png"))

ggplot(fishers_vuln, aes(x = indv_ac, y = fishery, fill = fishery)) +
  geom_density_ridges() +
  theme_ridges() + 
  theme(legend.position = "none")

ggplot(responses, aes(x = indv_vulnerability_euc, y = state, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2) +
  scale_fill_viridis(name = "indv_vulnerability_euc", option = "C") +
  labs(title = 'vulnerability by state') +
  theme_ipsum() +
    theme(
      plot.title = element_text(size = 4),
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 10)
    )

ggplot(fishers_vuln, aes(x = indv_exposure, y = fishery, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 2) +
  scale_fill_viridis(name = "indv_exposure", option = "C") +
  labs(title = 'exposure') +
  theme_ipsum() +
    theme(plot.title = element_text(size = 8),
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

```

##what do salmon fishers think of climate change
```{r}
#q37 plotting using likert package

q37<-salmonfishers %>%
  select(believe, harm_me, harm_future, leave_fishing, risk, no_point, no_fish)

#add statements as column headers
q37_statements<-c(
  "I believe climate change is occurring",
  "Climate change will harm me personally",
  "Climate change will harm future generations",
  "If I had a choice I would leave fishing",
  "It is a big risk to move into a new fishery",
  "There is no point in preparing for climate change since we don't know exactly what is going to happen",
  "There will not be enough fish to continue to operate in my main fishery in 20 years")
colnames(q37)<-q37_statements

#setting the levels
#levels need to be set since each possible answer does not appear in each column
mylevels <- c('strongly_disagree', 'somewhat_disagree', 'neutral', 'somewhat_agree', 'strongly_agree')
for(i in seq_along(q37)) {
  q37[,i] <- factor(q37[,i], levels=mylevels)
}

future_thoughts<-likert(q37)
summary(future_thoughts)
climate_perspectives<-plot(future_thoughts, colors=c('orange','darkorange', "gray", 'darkblue','blue'))

ggsave(plot = climate_perspectives, height = 7, width = 10, file = paste0("../figures/fishery_specific/climate_perspectives_salmon.png"))

#by state
future_thoughts_states<-likert(q37, grouping = salmonfishers$state_code)
climate_perspectives_states_plot<-plot(future_thoughts_states, colors=c('orange','darkorange', "gray", 'darkblue','blue'))

ggsave(plot = climate_perspectives_states_plot, height = 12, width = 10, file = paste0("../figures/fishery_specific/climate_perspectives_salmon_state.png"))

```

##climate effects on species by state
```{r climate species region}


species_climate<-responses %>%
  select(salmon_warming, dc_warming, state_code)

table(species_climate$salmon_warming, species_climate$state_code)
chisq.test(table(species_climate$salmon_warming, species_climate$state_code))

chisq.test(table(species_climate$dc_warming, species_climate$state_code))
```
##by region
```{r}
sal_region<-responses%>%
  select(salmon_warming, wa_coast, pugetsound_SJF, cr, or_coast, norcal, cencal, socal)

sal_region <-sal_region %>% group_by(salmon_warming) %>%
  summarise(
    wa_coast = sum(wa_coast),
    pugetsound_SJF = sum(pugetsound_SJF),
    cr = sum(cr),
    or_coast = sum(or_coast),
    norcal = sum(norcal),
    cencal = sum(cencal),
    socal = sum(socal))

sr<-chisq.test(sal_region[,2:8])

library(corrplot)
corrplot(sr$residuals, is.corr = FALSE)

library(reshape2)
sal_region_melted<-melt(sal_region)

p <- ggplot(sal_region_melted, aes(x =variable, y = salmon_warming)) 
p+geom_point( aes(size=value))+theme(panel.background=element_blank(), panel.border = element_rect(colour = "blue", fill=NA, size=1))

library(graphics)
mosaicplot(sal_region, shade = TRUE, las=2,
           main = "warming thoughts by region")
```

##Belief in climate change by age/years fishing
```{r belief in climate change}
lob$believe <- factor(lob$believe, levels = c("strongly_disagree", "somewhat_disagree", "neutral", "somewhat_agree", "strongly_agree"))
lob$age <- factor(lob$age, levels = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"))
lob$yrs_fishing <- factor(lob$yrs_fishing, levels = c("0-5", "5-15", "15-25", "25+"))

# I want to dot his as a proprotion instead of count but not quite sure the best way to do that right now
cc_belief_lob_plot <- ggplot(data = lob, aes (x=believe, fill = age))+
  geom_bar(position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("In the lobster fishery believe that climate change is occuring") 

cc_belief_lob_plot <- ggplot(data = lob, aes (x=believe, fill = yrs_fishing))+
  geom_bar(position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("In the lobster fishery believe that climate change is occuring") 

ggsave(plot = cc_lob_plot, file = paste0("../figures/climate_change_belief_lob.png"))

```

##Believe that climate change will harm them by age
```{r climate change harm me - age}
#Believe that climate change will harm them personally
lob$harm_me <- factor(lob$harm_me, levels = c("strongly_disagree", "somewhat_disagree", "neutral", "somewhat_agree", "strongly_agree"))

lob$age <- factor(lob$age, levels = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"))

cc_harm_me_by_age_plot <- ggplot(data = lob, aes (x=harm_me, fill = age))+
  geom_bar(position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Believe that climate change will harm them personally") 

ggsave(plot = cc_harm_me_by_age_plot, file = paste0("../figures/climate_change_harm_me_age.png"))

```

##Believe that climate change will harm future generations by age
```{r climate change harm future - age}
#Believe that climate change will harm future generations
lob$harm_future <- factor(lob$harm_future, levels = c("strongly_disagree", "somewhat_disagree", "neutral", "somewhat_agree", "strongly_agree"))

lob$age <- factor(lob$age, levels = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"))

cc_harm_future_by_age_plot <- ggplot(data = lob, aes (x=harm_future, fill = age))+
  geom_bar(position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Believe that climate change will harm future generations") 

ggsave(plot = cc_harm_future_by_age_plot, file = paste0("../figures/climate_change_harm_future_age.png"))

```


##ability to catch fish has been affected by climate change
```{r ability to catch fish}
#Do you think your ability to catch fish has been affected by climate change?
#This is an interesting plot, it doesn't appear people think that climate change has really impacted their ability to catch fish
#does this mean they think their fishing ability is indepent of climate change?
lob$ability <- factor(lob$ability, levels = c("no", "no_obs_change", "yes_neg", "yes_pos"))

lob$age <- factor(lob$age, levels = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"))

cc_ability_by_age_plot <- ggplot(data = lob, aes (x=ability, fill = age))+
  geom_bar(position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Climate change has affected ability to catch fish") 

ggsave(plot = cc_ability_by_age_plot, file = paste0("../figures/climate_change_ability_age.png"))

```
#adding to the fishery average matrix
```{r}
fisheryavgmatrix = matrix(NA, nrow = 13, ncol = 10)
colnames(fisheryavgmatrix) <- c("fishery", "avg_exposure", "avg_sensitivity", "avg_ac", "ac_sd", "avg_risk", "risk_sd", "avg_risk_euc", "avg_vulnerability", "avg_vulnerabilty_euc")
fisheryavgmatrix[,1] = c("CPS", "dungeness crab", "geoduck", "groundfish", "hake", "HMS", "razor clam", "salmon", "scallops", "sea cucumber", "sea urchin", "shrimp", "squid")

#subset to the fishery and avg vulnerability by people who fish for that fishery
for(i in 1:nrow(fisheryavgmatrix)) {
  index = which(grepl(fisheryavgmatrix[i,1], responses$listoffisheries) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  fisheryavgmatrix[i,2] = mean(responses$indv_exposure[index], na.rm = TRUE)
  fisheryavgmatrix[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  fisheryavgmatrix[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix[i,5] = sd(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix[i,6] = mean(responses$indv_risk[index], na.rm = TRUE)
  fisheryavgmatrix[i,7] = sd(responses$indv_risk[index], na.rm = TRUE)
  fisheryavgmatrix[i,8] = mean(responses$risk_euc[index], na.rm = TRUE)
  fisheryavgmatrix[i,9] = mean(responses$indv_vulnerability[index], na.rm = TRUE)
  fisheryavgmatrix[i,10] = mean(responses$indv_vulnerability_euc[index], na.rm = TRUE)
}

#change to a dataframe and to numeric
fishery_summary<-as.data.frame(fisheryavgmatrix)
fishery_summary[,2:10]<-sapply(fishery_summary[,2:10], as.numeric)
write.csv(fishery_summary, paste0("../data/fishery_vuln_summary.csv"))

fishery_summary<-round(fishery_summary[,2:10], digits = 2)
```
