---
output:
  word_document: default
  html_document: default
---
 ---
title: "Vulnerability calculations"
author: "Laura"
date: "11/30/2020"
output: word_document
---

####Calculating perceptions of vulnerability based upon the exposure, sensitivity, and adaptive capacity of survey participants.
##saves figures into folder ("../figures/vulnerability)

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(ggpubr)
library(PNWColors)
library(car)
library(GGally)
library(ggridges)
library(reshape2)
# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```

```{r}
pal1 <- pnw_palette("Bay", 1)
pal3 <- pnw_palette("Bay", 3, type = "discrete")
pal4 <- pnw_palette("Bay", 4, type = "discrete") #this was pal
pal5 <- pnw_palette("Bay", 5, type = "discrete")

```

#load data with state code additions
```{r data}
responses <- read.csv("../data/decoded_responses_10.Jun.2021.csv")#update to recent responses file
```
#data with vulnerability calculations
```{r data}
responses <- read.csv("../data/NE_decoded_vulnerability.csv")#update to recent responses file
```

##functions to get likert answers to a 0 to 1 scale 
```{r functions}
#giving exposure a scale of 0 to 1, where a fishery that will be strongly negatively affected by climate change scores a 1. Higher score means higher exposure.
exposure_calc <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strong_neg"){
  return(1)
} else if(x == "slight_neg"){
  return(0.75)
} else if(x == "no_effect"){
  return(.5)
} else if (x == "slight_pos"){
  return(.25)
} else if (x == "strong_pos"){
  return(0)
} else if (x == "idk") {
  return("NA")
}
}

#Recoding likert answers on a scale of 0 to 1 where strongly agree equals 1. To be applied for sensitity and adaptive capacity or other applicable situations.
sensitivity_ac <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strongly_agree"){
  return(1)
} else if(x == "somewhat_agree"){
  return(.75)
} else if(x == "neutral"){
  return(.5)
} else if (x == "somewhat_disagree"){
  return(.25)
} else if (x == "strongly_disagree"){
  return(0)
} else if (x == "I have not observed any changes") {#this was NA but now we are including it as neutral
  return(0.5)
}
}

#Recoding likert in opposite for two inverse adaptive capcity questions, strongly agree equals 1 and higher score equals higher adaptive
ac_scale <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strongly_agree"){
  return(0)
} else if(x == "somewhat_agree"){
  return(.25)
} else if(x == "neutral"){
  return(.5)
} else if (x == "somewhat_disagree"){
  return(.75)
} else if (x == "strongly_disagree"){
  return(1)
} else if (x == "I have not observed any changes") { #this is not actually an option and will just be left out
  return("NA")
}
}
```

##exposure
##changing from likert responses to numbers in order to calculate exposure index
```{r changing responses for exposure index}
responses <- responses %>% 
  mutate(lob_warming = sapply(X=responses$lob_warming, FUN=exposure_calc),
         
         herr_warming = sapply(X=responses$herr_warming, FUN=exposure_calc),
        
         men_warming = sapply(X=responses$men_warming, FUN=exposure_calc),
         
         sclp_warming = sapply(X=responses$sclp_warming, FUN=exposure_calc),
         
         cod_warming = sapply(X=responses$cod_warming, FUN=exposure_calc),
         
         hadk_warming = sapply(X=responses$hadk_warming, FUN=exposure_calc),

         polk_warming = sapply(X=responses$polk_warming, FUN=exposure_calc),
        
         halbt_warming = sapply(X=responses$halbt_warming, FUN=exposure_calc),
         
         wht_hake_warming = sapply(X=responses$wht_hake_warming, FUN=exposure_calc),
         
         dabs_warming = sapply(X=responses$dabs_warming, FUN=exposure_calc),
         
         gry_sole_warming = sapply(X=responses$gry_sole_warming, FUN=exposure_calc),
         
         windowpane_warming = sapply(X=responses$windowpane_warming, FUN=exposure_calc),
         
         yellowtail_warming = sapply(X=responses$yellowtail_warming, FUN=exposure_calc),
         
         wnt_flnder_warming = sapply(X=responses$wnt_flnder_warming, FUN=exposure_calc),
         
         redfish_warming = sapply(X=responses$redfish_warming, FUN=exposure_calc),
         
         monkfish_warming = sapply(X=responses$monkfish_warming, FUN=exposure_calc),
         
         skates_warming = sapply(X=responses$skates_warming, FUN=exposure_calc),
         
         whiting_warming = sapply(X=responses$whiting_warming, FUN=exposure_calc),
         
         red_hake_warming = sapply(X=responses$red_hake_warming, FUN=exposure_calc),
         
         red_crab_warming = sapply(X=responses$red_crab_warming, FUN=exposure_calc),
         
         clams_warming = sapply(X=responses$clams_warming, FUN=exposure_calc),
         
         squid_warming = sapply(X=responses$squid_warming, FUN=exposure_calc),
         
         dogfish_warming = sapply(X=responses$dogfish_warming, FUN=exposure_calc),
        
         summer_flnder_warming = sapply(X=responses$summer_flnder_warming, FUN=exposure_calc),
         
         scup_warming = sapply(X=responses$scup_warming, FUN=exposure_calc),
        
         black_seabass_warming = sapply(X=responses$black_seabass_warming, FUN=exposure_calc),
         
         other_warming = sapply(X=responses$other_warming, FUN=exposure_calc))



```

#is there a way to combine these responses for multispecies groundfish and small mesh fisheries?

#multispecies = cod, haddock, pollock, redfish, inter flounder, yellowtail, halibut, wolffish, white hake, plaice/dabs, witch flounder, windowpane flounder, ocean pout

#small mesh species = silver hake, red hake, whiting

##Exposure based on perceptions of how will climate affect ALL fisheries
```{r average exposure score for each fishery}
fishery_exposure<-responses %>%
        select(lob_warming, herr_warming, men_warming, sclp_warming, cod_warming, hadk_warming, polk_warming, halbt_warming, wht_hake_warming, dabs_warming, gry_sole_warming, windowpane_warming, yellowtail_warming, wnt_flnder_warming, redfish_warming, monkfish_warming, skates_warming, whiting_warming, red_hake_warming, red_crab_warming, clams_warming, squid_warming, dogfish_warming, summer_flnder_warming, scup_warming, black_seabass_warming, other_warming)

#fishery exposure as the average of all the responses for that fishery
fishery_exposure<-as.data.frame(sapply(fishery_exposure, as.numeric))
fishery_avg_exposure<-colMeans(fishery_exposure, na.rm = TRUE)
fishery_avg_exposure<-as.data.frame(fishery_avg_exposure)
fishery_avg_exposure$sd = apply(fishery_exposure, 2, sd, na.rm=TRUE)



#if we consider an inviduals exposure to be the average of their responses for all fisheries
individual_exposure<-rowMeans(fishery_exposure, na.rm = TRUE)
responses$indv_exposure_af = individual_exposure #individual exposure is the exposure calculation used. if I want to use perceptions of all fisheries instead of just the ones you participate in remove _af from this line. Either don't run Rmarkdown or go into fishery specific exposure code to make the same change. 

```

##Exposure based upon perceptions of how climate will affect only the fisheries you participate in
##calling other Rmd file with code that calculates exposure that way and adds it to responses as a column called fishery_specific_exposure
```{r render fishery specific exposure}
rmarkdown::render("NE_Fishery specific exposure.Rmd")
```

##sensitivity index
```{r sensitivity calculation}
#q39 Please agree or disagree with statements describing how changes in the environment and fisheries have affected your health and wellbeing

responses <- responses %>% 
  mutate(fish_neg_wellbeing = sapply(X=responses$fish_neg_wellbeing, FUN=sensitivity_ac),
         fish_neg_health = sapply(X=responses$fish_neg_health, FUN = sensitivity_ac),
         fish_neg_mental = sapply(X=responses$fish_neg_mental, FUN = sensitivity_ac),
         fish_increase_stress = sapply(X=responses$fish_increase_stress, FUN = sensitivity_ac),
         env_neg_welbeing = sapply(X=responses$fish_neg_wellbeing, FUN = sensitivity_ac),
         env_neg_health = sapply(X=responses$env_neg_health, FUN = sensitivity_ac),
         env_neg_mental = sapply(X=responses$env_neg_mental, FUN = sensitivity_ac),
         env_increase_stress = sapply(X=responses$env_increase_stress, FUN = sensitivity_ac),
         env_neg_safety = sapply(X=responses$env_neg_safety, FUN = sensitivity_ac))

#if we consider an inviduals sensitivity to be the average of their responses for q39
sens_index<-responses%>%
  select(fish_neg_health, fish_neg_mental, fish_neg_wellbeing, fish_increase_stress, env_neg_health, env_neg_mental, env_neg_safety, env_neg_welbeing, env_increase_stress)
sens_index<-as.data.frame(sapply(sens_index, as.numeric))
responses$indv_sensitivity<-rowMeans(sens_index, na.rm = TRUE)

```

##adaptive capacity 
#should I include owning a vessel in adaptive capacity, some of the crew responded I think?
```{r adapative capacity calculation}
#q43 With regard to the future security of yourself, your residential community, or your fishery, please indicate the extent to which you agree or disagree with the following statements. Most statements worded so that agreeing = higher adaptive capacity. r7 and r9 are the inverse, agreeing = lower adaptive capacity. The higher number you have the higher your adaptive capacity is.


#rescoring note where different function is needed
responses <- responses %>% 
  mutate(new_fishery = sapply(X=responses$new_fishery, FUN=sensitivity_ac),
         nat_resource_job = sapply(X=responses$nat_resource_job, FUN=sensitivity_ac),
         other_job = sapply(X=responses$other_job, FUN=sensitivity_ac),
         loan = sapply(X=responses$loan, FUN=sensitivity_ac),
         distance = sapply(X=responses$distance, FUN=sensitivity_ac),
         strong_comm = sapply(X=responses$strong_comm, FUN=sensitivity_ac),
         climate_refugees = sapply(X=responses$climate_refugees, FUN=ac_scale),
         adapt_mgmt = sapply(X=responses$adapt_mgmt, FUN=sensitivity_ac),
         const_reg = sapply(X=responses$const_reg, FUN=ac_scale))

#if we consider an inviduals adaptive capacity to be the average of their responses for q43
ac_index<-responses%>%
  select(new_fishery, nat_resource_job, other_job, loan, distance, strong_comm, climate_refugees, adapt_mgmt, const_reg)
ac_index<-as.data.frame(sapply(ac_index, as.numeric))
responses$indv_ac<-rowMeans(ac_index, na.rm = TRUE)



```

##individual vulnerability
```{r individual vulnerability}
#putting exposure, sensitivity, and ac together

#invidual risk where r = e + s
#not weighted at all
risk<-cbind(responses$indv_exposure, responses$indv_sensitivity)
responses$indv_risk = rowSums(risk, na.rm = TRUE)

#starting with v = e + s - ac (Cinner 2012)
#same as v = risk - ac
responses$indv_vulnerability = responses$indv_risk - responses$indv_ac

#vulnerability by euclidean distance (Levin and Samhouri 2012)
#risk = sqrt(e^2 + s^2)
#v = sqrt(e^2 + s^2 (1-ac)^2)
responses$risk_euc = sqrt(responses$indv_exposure^2 + responses$indv_sensitivity^2)

#Do inverse of adaptive capacity like Davies (2018) where higher number corresponds to lower adaptive capacity
responses$inverse_ac = 1-responses$indv_ac

#for inverse_ac a higher number equals lower adaptive capacity
#use this for euclidean distance for vulnerability

responses$indv_vulnerability_euc=sqrt(responses$indv_exposure^2 + responses$indv_sensitivity^2 + responses$inverse_ac^2)

#exploring how the two methods compare
#check risk first
risk_rank<-rank(responses$indv_risk, na.last = "keep")
risk_euc_rank<-rank(responses$risk_euc, na.last = "keep")
risk_diff<-risk_rank-risk_euc_rank
risk_rankings<-cbind.data.frame(risk_rank, risk_euc_rank, risk_diff)

#vulnerability differences between methods
vuln_rank<-rank(responses$indv_vulnerability, na.last = "keep")
vuln_euc_rank<-rank(responses$indv_vulnerability_euc, na.last = "keep")
vuln_diff<-vuln_rank-vuln_euc_rank
vuln_rankings<-cbind.data.frame(vuln_rank, vuln_euc_rank, vuln_diff)

allrankings<-cbind.data.frame(risk_rank, risk_euc_rank, risk_diff, vuln_rank, vuln_euc_rank, vuln_diff)


#save for vulnerability comparisons
write.csv(allrankings, paste0("../data/vulnerability_comparisons.csv"))

#for a small group of individuals, the method makes a big difference
#look at correlation in ranks
all_ranks<-cbind.data.frame(risk_rank, risk_euc_rank, vuln_rank, vuln_euc_rank)
rank_cor<-cor(all_ranks, use = "complete.obs")
rank_cor

```

#summary of vulnerability and its components for all
```{r vulnerability summary}

vulnsummary = responses %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   ex_sd = sd(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   sensitivity_sd = sd(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   adaptive_sd = sd(indv_ac),
                   vuln_euc_avg = mean(indv_vulnerability_euc, na.rm = TRUE),
                   vuln_euc_sd = sd(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
)

vulnsummary

vulnridge<-responses %>%
  select(indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc)


vulnride_long<- melt(vulnridge) #from libarary(reshape2)

ggplot(vulnride_long, aes(x = value, y = variable, fill = variable)) +
  geom_density_ridges() + #from library(ggridges)
  theme_ridges() + 
  theme(legend.position = "none")


```


#subseting by fishery - aggregated groundfish and whiting species
#not currently using this approach but have the code here if I wante to change my mind to aggregate fisheries 9.10.2021
```{r make a new column and specify fishery(ies) for each person}

# #modifed from code written by Laura Koehn
# #use to calculate average vulnerability across a fishery
# #modify for each survey
# 
# 
# responses$listoffisheries = rep(NA, length =  nrow(responses))
# # loop through each person and get what they are fishing for, put in new column
# # should list each fishery they fish for
# # not beautiful code but works
# 
# for(i in 1: nrow(responses)) {
#   fisheriesname = ""
#   if(responses$lobster[i] == 1) {
#     fisheriesname = paste(fisheriesname, "lobster", sep = "") 
#   }
#   if(responses$groundfish_category[i] == "groundfish") {
#     if(fisheriesname == "") { # have to do extra to not put a , at the beginning
#       # if this is the first fishery 
#       fisheriesname = paste(fisheriesname, "groundfish", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "groundfish", sep = ", ")
#     }
#   }
#   if(responses$groundfish_category[i] == "whiting") {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "whiting", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "whiting", sep = ", ")
#     }
#   }
#   if(responses$herring[i] == 1) {
#     if(fisheriesname == "") {
#     fisheriesname = paste(fisheriesname, "herring", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "herring", sep = ", ")
#     }
#   }
#   if(responses$menhaden[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "menhaden", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "menhaden", sep = ", ")
#     }
#   }
#   if(responses$scallop[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "scallop", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "scallop", sep = ", ")
#     }
#   }
#   if(responses$skates[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "skates", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "skates", sep = ", ")
#     }
#   }
#   if(responses$red_crab[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "red crab", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "red crab", sep = ", ")
#     }
#   }
#   if(responses$clams[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "clams", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "clams", sep = ", ")
#     }
#   }
#   if(responses$squid[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "squid", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "squid", sep = ", ")
#     }
#   }
#   if(responses$dogfish[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "dogfish", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "dogfish", sep = ", ")
#     }
#   }
#   if(responses$scup[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "scup", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "scup", sep = ", ")
#     }
#   }
#   if(responses$black_seabass[i] == 1) {
#     if(fisheriesname == "") {
#       fisheriesname = paste(fisheriesname, "black sea bass", sep = "")
#     } else {
#       fisheriesname = paste(fisheriesname, "black sea bass", sep = ", ")
#     }
#   }
#   if(responses$other[i] == 1) {
#     if(fisheriesname == "") { 
#     fisheriesname = paste(fisheriesname, responses$species[i], sep = "")
#     #paste in what the person put for "other"
#     }else {
#       fisheriesname = paste(fisheriesname, responses$species[i], sep = ", ")
#     }
#   }
#   responses$listoffisheries[i] = fisheriesname
# }
# 
# ### Average across each UNIQUE "fishery" - so if they fish for salmon AND HMS, gets
# # treated different than just fishing for salmon
# #could use if fuction to pull out whatever "fishery" is desired with this method
# 
# 
# 
# library(plyr)
# fisheryavg = ddply(responses, c("listoffisheries"), summarise,
#                    exposure_avg = mean(indv_exposure, na.rm = TRUE),
#                    sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
#                    adaptive_avg = mean(indv_ac),
#                    vuln_avg = mean(indv_vulnerability)
#                    
# 
# )
# lknfisheryavg = responses %>%
#   group_by(listoffisheries) %>%
#   dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
#                    sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
#                    adaptive_avg = mean(indv_ac),
#                    vuln_avg = mean(indv_vulnerability),
#                    vuln_euc_avg = mean(indv_vulnerability_euc),
#                    count = n()
# )
#     
# dungycrab %>%
#   group_by(vessel) %>%
#   dplyr::summarise(mean = mean(indv_vulnerability),
#                    count = n(),
#                    sd = sd(indv_vulnerability)
#   )

### Average across each UNIQUE "fishery" - so if they fish for salmon AND HMS, gets
# treated different than just fishing for salmon
#could use if fuction to pull out whatever "fishery" is desired with this method



```

#subsetting by fishery
#divide out groundfish and whiting
```{r make a new column and specify fishery(ies) for each person disaggregated}


#modifed from code written by Laura Koehn
#use to calculate average vulnerability across a fishery
#modify for each survey

responses$listoffisheries = rep(NA, length =  nrow(responses))
# loop through each person and get what they are fishing for, put in new column
# should list each fishery they fish for
# not beautiful code but works


for(i in 1: nrow(responses)) {
  fisheriesname = ""
  if(responses$lobster[i] == 1) {
    fisheriesname = paste(fisheriesname, "lobster", sep = "") 
  }
  if(responses$herring[i] == 1) {
    if(fisheriesname == "") {
    fisheriesname = paste(fisheriesname, "herring", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "herring", sep = ", ")
    }
  }
  if(responses$menhaden[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "menhaden", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "menhaden", sep = ", ")
    }
  }
  if(responses$scallop[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "scallop", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "scallop", sep = ", ")
    }
  }
  if(responses$cod[i] == 1) {
   if(fisheriesname == "") { 
      fisheriesname = paste(fisheriesname, "cod", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "cod", sep = ", ")
    }
}
if(responses$haddock[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "haddock", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "haddock", sep = ", ")
    }
}
  if(responses$pollock[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "pollock", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "pollock", sep = ", ")
    }
  }
  if(responses$halibut[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "halibut", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "halibut", sep = ", ")
    }
  }
  if(responses$white_hake[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "white_hake", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "white_hake", sep = ", ")
    }
  }
   if(responses$dabs[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "dabs", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "dabs", sep = ", ")
    }
   }
   if(responses$gray_sole[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "gray_sole", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "gray_sole", sep = ", ")
    }
   }
  if(responses$windowpane[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "windowpane", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "windowpane", sep = ", ")
    }
  }
  if(responses$yellowtail[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "yellowtail", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "yellowtail", sep = ", ")
    }
  }
  
if(responses$winter_flounder[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "winter_flounder", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "winter_flounder", sep = ", ")
    }
}
  
  if(responses$redfish[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "redfish", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "redfish", sep = ", ")
    }
  }
   if(responses$monkfish[i] == 1) {
  if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "monkfish", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "monkfish", sep = ", ")
    }
   }
  if(responses$skates[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "skates", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "skates", sep = ", ")
    }
  }
  if(responses$whiting[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "whiting", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "whiting", sep = ", ")
    }
  }
  if(responses$red_hake[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "red_hake", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "red_hake", sep = ", ")
    }
  }
  if(responses$red_crab[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "red crab", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "red crab", sep = ", ")
    }
  }
  if(responses$clams[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "clams", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "clams", sep = ", ")
    }
  }
  if(responses$squid[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "squid", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "squid", sep = ", ")
    }
  }
  if(responses$dogfish[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "dogfish", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "dogfish", sep = ", ")
    }
  }
  if(responses$summer_flounder[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "summer_flounder", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "summer_flounder", sep = ", ")
    }
  }
  if(responses$scup[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "scup", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "scup", sep = ", ")
    }
  }
  if(responses$black_seabass[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "black sea bass", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "black sea bass", sep = ", ")
    }
  }
  if(responses$other[i] == 1) {
    if(fisheriesname == "") { 
    fisheriesname = paste(fisheriesname, responses$species[i], sep = "")
    #paste in what the person put for "other"
    }else {
      fisheriesname = paste(fisheriesname, responses$species[i], sep = ", ")
    }
  }
  responses$listoffisheries[i] = fisheriesname
}

### Average across each UNIQUE "fishery" - so if they fish for salmon AND HMS, gets
# treated different than just fishing for salmon
#could use if fuction to pull out whatever "fishery" is desired with this method



fisheryavg = responses %>%
  group_by(listoffisheries) %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability),
                   vuln_euc_avg = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
                   
)


```


##average vulnerability by fishery
```{r other ways to subset from Koehn}
#looking at it with groundfish combined
# fisheryavgmatrix = matrix(NA, nrow = 13, ncol = 10)
# colnames(fisheryavgmatrix) <- c("fishery", "avg_exposure", "avg_sensitivity", "avg_ac", "ac_sd", "avg_risk", "risk_sd", "avg_risk_euc", "avg_vulnerability", "avg_vulnerabilty_euc")
# fisheryavgmatrix[,1] = c("lobster", "groundfish", "whiting", "herring", "menhaden", 
#                          "scallop", "skates","red crab", "clams", "squid", "dogfish", "scup", "black sea bass")


#looking at it with groundfish disagreegated 
#this is looking at the average vulnerability of people participating in this fishery
fisheryavgmatrix = matrix(NA, nrow = 26, ncol = 10)

colnames(fisheryavgmatrix) <- c("fishery", "avg_exposure", "avg_sensitivity", "avg_ac", "ac_sd", "avg_risk", "risk_sd", "avg_risk_euc", "avg_vulnerability", "avg_vulnerabilty_euc")

fisheryavgmatrix[,1] = c("lobster", 
                         "herring", 
                         "menhaden",
                         "scallop", 
                         "cod", 
                         "haddock", 
                         "pollock", 
                         "halibut", 
                         "white_hake",
                         "dabs", 
                         "gray_sole",
                         "windowpane", 
                         "yellowtail", 
                         "winter_flounder", 
                         "redfish",
                         "monkfish",
                         "skates",
                         "whiting",
                         "red_hake",
                         "red crab",
                         "clams", 
                         "squid", 
                         "dogfish", 
                         "summer_flounder", 
                         "scup", 
                         "black sea bass")



#subset to the fishery and avg vulnerability by people who fish for that fishery
for(i in 1:nrow(fisheryavgmatrix)) {
  index = which(grepl(fisheryavgmatrix[i,1], responses$listoffisheries) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  fisheryavgmatrix[i,2] = mean(responses$indv_exposure[index], na.rm = TRUE)
  fisheryavgmatrix[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  fisheryavgmatrix[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix[i,5] = sd(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix[i,6] = mean(responses$indv_risk[index], na.rm = TRUE)
  fisheryavgmatrix[i,7] = sd(responses$indv_risk[index], na.rm = TRUE)
  fisheryavgmatrix[i,8] = mean(responses$risk_euc[index], na.rm = TRUE)
  fisheryavgmatrix[i,9] = mean(responses$indv_vulnerability[index], na.rm = TRUE)
  fisheryavgmatrix[i,10] = mean(responses$indv_vulnerability_euc[index], na.rm = TRUE)
  #average vulnerability across any fisherman that fishes that fishery -
  #would need to add columns to the matrix and then calculate avg exposure, avg 
  #sensitivity, etc. 
}

#change to a dataframe and to numeric
fishery_summary<-as.data.frame(fisheryavgmatrix)
fishery_summary[,2:10]<-sapply(fishery_summary[,2:10], as.numeric)

fishery_summary
```


Components of vulnerability based upon the unique combination of regions someone fishes in.

#use the same method to look at regions
##subset by region
#change this for the Northeast

```{r  regional vulnerability, echo = FALSE}

#modify for different surveys


responses$listofregions = rep(NA, length =  nrow(responses))
# loop through each person and get what they are fishing for, put in new column
# should list each fishery they fish for
# not beautiful code but works
for(i in 1: nrow(responses)) {
  regionname = ""
  if(responses$inshore_gom[i] == 1) {
    regionname = paste(regionname, "inshore_gom", sep = "") 
  }
  if(responses$offshore_gom[i] == 1) {
    if(regionname == "") { # have to do extra to not put a , at the beginning
      # if this is the first fishery 
      regionname = paste(regionname, "offshore_gom", sep = "")
    } else {
      regionname = paste(regionname, "offshore_gom", sep = ", ")
    }
  }
  if(responses$gb[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "gb", sep = "")
    } else {
      regionname = paste(regionname, "gb", sep = ", ")
    }
  }
  if(responses$sne[i] == 1) {
    if(regionname == "") {
    regionname = paste(regionname, "sne", sep = "")
    } else {
      regionname = paste(regionname, "sne", sep = ", ")
    }
  }
  if(responses$lis[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "lis", sep = "")
    } else {
      regionname = paste(regionname, "lis", sep = ", ")
    }
  }
  if(responses$mid[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "mid", sep = "")
    } else {
      regionname = paste(regionname, "mid", sep = ", ")
    }
  }
  
  responses$listofregions[i] = regionname
}

### Average across each UNIQUE "fishery" - so if they fish for salmon AND HMS, gets
# treated different than just fishing for salmon
#could use if fuction to pull out whatever "fishery" is desired with this method



regionavg = responses %>%
  group_by(listofregions) %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability),
                   vuln_euc_avg = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
                   
)

regionavg
```

Or if we average by anyone that fishes in a particular region.
##average vulnerability by region
```{r echo = FALSE}
#grouped by a single regional fishing area

regionmatrix = matrix(NA, nrow = 6, ncol = 8)
colnames(regionmatrix) <- c("region", "avg_exposure", "avg_sensitivity", "avg_ac", "avg_risk", "avg_vulnerability", "avg_risk_euc", "avg_vulnerability_euc")
regionmatrix[,1] = c("inshore_gom", "offshore_gom", "gb", "sne", "lis",
                         "mid")

#subset to the fishery and avg vulnerability by people who fish for that fishery
for(i in 1:nrow(regionmatrix)) {
  index = which(grepl(regionmatrix[i,1], responses$listofregions) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  regionmatrix[i,2] = mean(responses$indv_exposure[index], na.rm = TRUE)
  regionmatrix[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  regionmatrix[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  regionmatrix[i,5] = mean(responses$indv_risk[index], na.rm = TRUE)
  regionmatrix[i,6] = mean(responses$indv_vulnerability[index], na.rm = TRUE)
  regionmatrix[i,7] = mean(responses$risk_euc[index], na.rm = TRUE)
  regionmatrix[i,8] = mean(responses$indv_vulnerability_euc[index], na.rm = TRUE)
  #average vulnerability across any fisherman that fishes that fishery -
  #would need to add columns to the matrix and then calculate avg exposure, avg 
  #sensitivity, etc. 
}

#change to a dataframe and to numeric
region_summary<-as.data.frame(regionmatrix)
region_summary[,2:8]<-sapply(region_summary[,2:8], as.numeric)

region_summary
```

##exploratory figures

Visualing risk.

##visualizing individual risk (exposure v sensitivity)
```{r risk plot}

risk_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity)) +
  geom_point()
risk_plot

ggsave(plot = risk_plot, file = paste0("../figures/vulnerability/risk.png"))

#looking at risk by age
risk_age_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = age)) +
  geom_point()
risk_age_plot

ggsave(plot = risk_age_plot, file = paste0("../figures/vulnerability/risk_age.png"))

#risk by how much income you get from fishing
risk_income_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = income)) +
  geom_point() +
  ggtitle("Risk and percentage of income from outside of fishing")
risk_income_plot

ggsave(plot = risk_income_plot, file = paste0("../figures/vulnerability/risk_income.png"))

#risk by state
risk_state_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = state_code)) +
  geom_point() +
  ggtitle("Risk and state of residence")
risk_state_plot

ggsave(plot = risk_state_plot, file = paste0("../figures/vulnerability/risk_state.png"))
```

First plot is additive risk, second is euclidean distance.
##considering average vulnerability based upon fishery participation
```{r vulnerability}

#basic risk vs ac
fishery_vulnerability_plot <- ggplot(fishery_summary, aes(x=avg_ac, y=avg_risk)) +
  geom_point() + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishery participants") +
  geom_text_repel(label = fishery_summary$fishery)
fishery_vulnerability_plot + scale_x_reverse(limits = c(.5, .25))# these limits don't make sense for adding 

ggsave(plot = fishery_vulnerability_plot, file = paste0("../figures/vulnerability/fishery_vulnerability.png"))


#using the euclidean distance method
fishery_vulnerability_euc_plot<-ggplot(fishery_summary, aes(x=avg_ac, y=avg_risk_euc)) +
  geom_point() + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") +
  ggtitle("Average vulnerability of fishery participants") +
  geom_text(label = fishery_summary$fishery, nudge_y = .01)
fishery_vulnerability_euc_plot<-fishery_vulnerability_euc_plot + scale_x_reverse(limits = c(.45, 0.3))

ggsave(plot = fishery_vulnerability_euc_plot, width = 10, height = 7, file = paste0("../figures/vulnerability/fishery_vulnerability_euc.png"))

fishery_vulnerability_plot
fishery_vulnerability_euc_plot
```

##considering average vulnerability based upon region fished
```{r average vulnerability by region, echo=F}

#basic risk vs ac plot
region_vulnerability_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk, label = region_summary$region)) +
  geom_point(color = "black") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_plot<-region_vulnerability_plot + scale_x_reverse()

region_vulnerability_plot

ggsave(plot = region_vulnerability_plot, file = paste0("../figures/vulnerability/region_vulnerability.png"))

#plotted with euc method
region_vulnerability_euc_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk_euc, label = region_summary$region)) +
  geom_point(color = "black") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_euc_plot<-region_vulnerability_euc_plot + scale_x_reverse()

region_vulnerability_euc_plot

ggsave(plot = region_vulnerability_euc_plot, file = paste0("../figures/vulnerability/region_vulnerability_euc.png"))
```
#fishery vulnerability rainbow plot
```{r}
# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
acrange <- seq(0.3,0.5, length.out = 100) #x
riskrange <- seq(0.5,1, length.out = 100) #y

vulnrange <- expand.grid(x = acrange, y = riskrange)


ranges = data.frame(acrange, riskrange, sqrt(riskrange^2 + acrange^2))
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(0.3,0.5,length.out=100) # scale of color for x and y,
yColor <- seq(0.5,1,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
foo <- expand.grid(x = 0:1, y = 0:1.5)
foo$z <- runif(nrow(foo))

myfuns <- list(Low = min, High = max)
ls_val <- unlist(lapply(myfuns, function(f) f(foo$z)))

p3 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk_euc)) +
  xlab("Average Adaptive Capacity") + ylab("Average Risk") + 
  ggtitle("Vulnerability based on fishery participation") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours = rev(cols), breaks = ls_val ) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery)+
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())
  
  # #geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))+
  #geom_linerange(fishery_summary, mapping = aes(xmin=avg_ac-ac_sd, xmax=avg_ac+ac_sd, y=avg_risk))
p3<- p3 + scale_x_reverse()
p3

ggsave(plot = p3, width = 10, height = 7, file = paste0("../figures/vulnerability/vulnerability_euc_rainbow.png"))
```


#fishery vulnerablity heat map
```{r}
fishheat<-fishery_summary %>%
  select(avg_exposure, avg_sensitivity, avg_ac, avg_vulnerabilty_euc)

rownames(fishheat) <- fishery_summary$fishery
colnames(fishheat) <- c("exposure", "sensitivity", "adaptive capacity", "vulnerability")

fishheat <- as.matrix(fishheat)
pal <- colorRampPalette(brewer.pal(100,"Blues"))(100)

png(file="heatmap.png")
heatmap(fishheat, scale = "column", Colv = NA, Rowv = NULL, cexCol = 1, las = .5, keep.dendro = FALSE, col = pal)
dev.off()

```

##3d plot
```{r 3d vulnerability plot}
#not the prettiest but kind of interesting
# install.packages("scatterplot3d")
library(scatterplot3d)
library(PNWColors)

d<-pnw_palette("Sailboat", n=26, type = "continuous")

png("../figures/vulnerability/3d vulnerability.png")
vd<-scatterplot3d(x=fishery_summary$avg_exposure, y=fishery_summary$avg_sensitivity, z=(1-fishery_summary$avg_ac),
                  angle = 50,
              main = "Average vulnerabilty of fishery participants",
              xlab = "exposure",
              ylab = "sensitivity",
              zlab = "inverse adpative capacity",
              pch = 18, type = "h",
              color = c(pnw_palette("Sailboat", n=26, type = "continuous"))
)
text(vd$xyz.convert(x=fishery_summary$avg_exposure, y=fishery_summary$avg_sensitivity, z=(1-fishery_summary$avg_ac)), labels = fishery_summary$fishery, cex = .6)

dev.off()

```
##exploring and visualizing differences in vulnerability and adaptive capacity between groups

##anova of vulnerability for vessel length
```{r compare vessel length}

#may need to adjust for different surveys

responses$vessel <- factor(responses$vessel, levels = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"))

responses %>%
  group_by(vessel) %>%
  drop_na(vessel) %>% 
  dplyr::summarise(mean = mean(indv_vulnerability),
                   count = n(),
                   sd = sd(indv_vulnerability) 
                     
  )

# Box plots
# Plot weight by group and color by group

vessel_vulnerability<-ggboxplot(responses, x = "vessel", y = "indv_vulnerability",
                                remove = NA,
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "vulnerability", xlab = "vessel length")

ggsave(plot = vessel_vulnerability, file = paste0("../figures/vulnerability/vesselvuln.png"))

#anova
vessel_aov<-aov(indv_vulnerability ~ vessel, data = responses)
summary(vessel_aov)

#repeat but use the euclidean distance calc of vulnerability
vessel_eucvulnerability<-ggboxplot(responses, x = "vessel", y = "indv_vulnerability_euc", remove = NA,
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "vulnerability", xlab = "vessel length")

ggsave(plot = vessel_eucvulnerability, file = paste0("../figures/vulnerability/vesselvuln_euc.png"))

#anova
euc_vessel_aov<-aov(indv_vulnerability_euc ~ vessel, data = responses)
summary(euc_vessel_aov)

#tukeys
TukeyHSD(vessel_aov)
TukeyHSD(euc_vessel_aov)
```

##anova for ac by vessel length
```{r ac for vessel length}

vessel_ac<-ggboxplot(responses, x = "vessel", y = "indv_ac", remove = NA,
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "adaptive capacity", xlab = "vessel length") +
        theme(plot.title = element_text(size = 22), axis.title = element_text(size = 16), legend.position = "none")
  
vessel_ac

ggsave(plot = vessel_ac, file = paste0("../figures/vulnerability/vesselac.png"))

#anova
ac_vessel_aov<-aov(indv_ac ~ vessel, data = responses)
summary(ac_vessel_aov)

#tukey HSD of anova
ac_vessel_tukey<-TukeyHSD(ac_vessel_aov)
ac_vessel_tukey
```
##how many fisheries are people participating in and how does that affect vulnerability and adpative capacity
```{r number of fisheries}
#adjust for different surveys

fishery_particpation <- responses %>%
        select(lobster, herring, menhaden, scallop, cod, haddock, pollock, halibut, white_hake, dabs, gray_sole,windowpane, yellowtail, winter_flounder, redfish, monkfish, skates, whiting, red_hake, red_crab, clams, squid, dogfish, summer_flounder,scup, black_seabass, other)

fishery_particpation$num_fisheries = rowSums(fishery_particpation)

responses$num_fisheries = fishery_particpation$num_fisheries

responses <- responses %>% 
  mutate(num_fisheries = case_when(
    num_fisheries == 1 ~ "1",
    num_fisheries == 2 ~ "2",
    num_fisheries == 3 ~ "3",
    num_fisheries == 4 ~ "4", 
    num_fisheries == 5 ~ "5",
    num_fisheries == 6 ~ "6",
    num_fisheries == 7 ~ "7",
    num_fisheries == 8 ~ "8",
    num_fisheries == 9 ~ "9",
    num_fisheries == 10 ~ "10+",
    num_fisheries == 11 ~ "10+",
    num_fisheries == 12 ~ "10+",
    num_fisheries == 13 ~ "10+",
    num_fisheries == 14 ~ "10+",
    num_fisheries == 15 ~ "10+",
    num_fisheries == 16 ~ "10+",
    num_fisheries == 17 ~ "10+",
    num_fisheries == 18 ~ "10+",
    num_fisheries == 19 ~ "10+",
    num_fisheries == 20 ~ "10+",
    num_fisheries == 21 ~ "10+",
    num_fisheries == 22 ~ "10+"))


#summary of vulnerability
responses %>%
  group_by(num_fisheries) %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability),
                   vuln_euc_avg = mean(indv_vulnerability_euc, na.rm = TRUE),
                   sd = sd(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
  )

num_fisheries_vuln_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_vulnerability_euc",
          # color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10+"),
          ylab = "average vulnerability", xlab = "number of fisheries participated in")

num_fisheries_vuln_range

ggsave(plot = num_fisheries_vuln_range, width = 10, height = 7, file = paste0("../figures/vulnerability/numfisheries_vuln.png"))

#anova
numfisheries_aov<-aov(indv_vulnerability_euc ~ num_fisheries, data = responses)
summary(numfisheries_aov)

#tukey HSD of anova
numfisheries_tukey<-TukeyHSD(numfisheries_aov)
numfisheries_tukey

#differences in adaptive capacity 
#summary of adaptive capacity

responses %>%
  group_by(num_fisheries) %>%
  dplyr::summarise(mean = mean(indv_ac, na.rm = TRUE),
                   count = n(),
                   sd = sd(indv_ac, na.rm = TRUE)
  )

num_fisheries_ac_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_ac",
          # color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10+"),
          ylab = "average vulnerability", xlab = "number of fisheries participated in")

num_fisheries_ac_range

ggsave(plot = num_fisheries_ac_range, file = paste0("../figures/vulnerability/numfisheries_ac.png"))

#anova
numfisheries_ac_aov<-aov(indv_ac ~ num_fisheries, data = responses)
summary(numfisheries_ac_aov)

#tukey HSD of anova
numfisheries_ac_tukey<-TukeyHSD(numfisheries_ac_aov)
numfisheries_ac_tukey

#anova
numfisheries_ex_aov<-aov(indv_exposure ~ num_fisheries, data = responses)
summary(numfisheries_ex_aov)

#tukey HSD of anova
numfisheries_ex_tukey<-TukeyHSD(numfisheries_ex_aov)
numfisheries_ex_tukey

leveneTest(indv_exposure ~ num_fisheries, data = responses)

#Extract the residuals
aov_residuals <- residuals(object = numfisheries_ex_aov )

# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals )

kruskal.test(indv_exposure ~ num_fisheries, data = responses)
pairwise.wilcox.test(responses$indv_exposure, responses$num_fisheries, p.adjust.method = "BH")
```

#percentage of income from fishing based on number of fisheries
```{r}
responses$income <- factor(responses$income, levels = c("none", "U10", "10-25", "25-50", "50+"))
responses$num_fisheries <- factor(responses$num_fisheries, levels = c("1","2","3","4","5","6","7","8","9","10+"))

responses_fisheries_plot <- ggplot(data = responses, aes(x=num_fisheries, fill = income))+
  # geom_bar(position = position_dodge(), stat="count")+
  geom_bar(aes(y = (..count..)/sum(..count..)))+
  # scale_y_continuous(labels=scales::percent) +
  xlab("number of fisheries\n")+ ylab("percent") +
  ggtitle("Fishing income by number of fisheries participating in") 
ggsave(plot = responses_fisheries_plot, file = paste0("../figures/vulnerability/numfisheries_income.png"))

```

##varibility in vulnerability depending on if you think climate change is happening or not
```{r belief in climate change}
responses$believecat = responses$believe


responses <- responses %>%
  mutate(believecat = case_when(
    believecat == "strongly_agree" ~ "agree",
    believecat == "somewhat_agree" ~ "agree",
    believecat == "neutral" ~ "neutral",
    believecat == "somewhat_disagree" ~ "disagree",
    believecat == "strongly_disagree" ~ "disagree"))

#components of vulnerability and belief in climate change
responses %>%
  group_by(believecat) %>%
  dplyr::summarise(meanex = mean(indv_exposure, na.rm = TRUE),
                   meansen = mean(indv_sensitivity, na.rm = TRUE),
                   meanac = mean(indv_ac, na.rm = TRUE),
                   meanvuln = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n())
#plot with either 3 categories (i.e. agree, disagree, neutral) or with all 5 categories
belief_vuln<-ggboxplot(responses, x = "believe", y = "indv_vulnerability_euc",
          # color = "believecat", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("strongly_disagree","somewhat_disagree", "neutral", "somewhat_agree", "strongly_agree"),
          # order = c("disagree","neutral", "agree"),
          ylab = "vulnerability", xlab = "I believe climate change is occuring")
ggsave(plot = belief_vuln, file = paste0("../figures/vulnerability/belief_vuln.png"))

#anova
beliefvuln_aov<-aov(indv_vulnerability_euc ~ believecat, data = responses)
summary(beliefvuln_aov)

#tukey HSD of vulnerability
beliefvuln_tukey<-TukeyHSD(beliefvuln_aov)
beliefvuln_tukey

#anova exposure
beliefex_aov<-aov(indv_exposure ~ believecat, data = responses)
summary(beliefex_aov)

#tukey HSD of exposure
beliefex_tukey<-TukeyHSD(beliefex_aov)
beliefex_tukey

#anova of sensitivity
beliefsen_aov<-aov(indv_sensitivity ~ believecat, data = responses)
summary(beliefsen_aov)

#tukey HSD of sensitivity
beliefsen_tukey<-TukeyHSD(beliefsen_aov)
beliefsen_tukey

#anova of adaptive capacity
beliefac_aov<-aov(indv_ac ~ believecat, data = responses)
summary(beliefac_aov)

#tukey HSD of vulnerability
beliefac_tukey<-TukeyHSD(beliefac_aov)
beliefac_tukey
```



##scatterplot of risk depending on your belief in climate change
```{r risk scatterplot}

#exposure vs sensitivity


belief_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, group = believecat, color = believecat)) +
  geom_point(size = 4, alpha = .8) + xlab("Exposure") + scale_color_manual(values = c("#0f85a0", "#edd746", "#dd4124"), breaks = c("agree", "neutral", "disagree")) +
  ylab("Sensitivity") +
  ggtitle("Risk and belief in climate change") +
  theme(plot.title = element_text(size = 22), axis.title = element_text(size = 16), legend.text = element_text(size = 12))
belief_plot

ggsave(plot = belief_plot, file = paste0("../figures/vulnerability/belief_vulnerability.png"))
```


##distribution of vulnerability
##vulnerability plots used in tnc talk
```{r distribution of vulnerability}


#density plot of individual vulnerability
fu<-ggplot(responses, aes(x=indv_vulnerability_euc))+
  geom_density(fill = pal1, alpha = .8) + 
  xlab("vulnerability") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 2.5)) + 
  ggtitle("Distribution of perceived vulnerability")+ 
  theme(plot.title = element_text(size = 22), axis.title.x = element_text(size = 16))
fu

ggsave(plot = fu, height = 7, width = 10, file = paste0("../figures/vulnerability/vuln_distribution.png"))

pu<-ggplot(responses, aes(x = indv_vulnerability_euc, group = believecat, fill = believecat))+
             geom_density(alpha = .6)+
  scale_fill_manual(values = pal3,breaks = c("agree", "neutral", "disagree") ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 3.5)) +
    ggtitle("Distribution of perceived vulnerability")+ 
  theme(plot.title = element_text(size = 22), axis.title.x = element_text(size = 16), legend.text = element_text(size = 12)) +
  xlab("vulnerability")
pu

ggsave(plot = pu, height = 7, width = 10, file = paste0("../figures/vulnerability/belief_distribution.png"))

```


##anova for adaptive capacity by age
```{r anova ac}
#can copy and paste to look at age and vulnerability or any number of factors
#ac/vulnerability and amount of income gained outside of fishing
#ac/vulnerability and role in the industry, etc


age_ac<-ggboxplot(responses, x = "age", y = "indv_ac",
          color = "age", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"),
          ylab = "adaptive capacity", xlab = "age")

ggsave(plot = vessel_ac, file = paste0("../figures/vulnerability/vesselac.png"))

#anova
age_aov<-aov(indv_ac ~ age, data = responses)
summary(age_aov)

#tukey HSD of anova
age_tukey<-TukeyHSD(age_aov)
age_tukey
```



#save with vulnerability calculations
```{r save file}
#change file name as desired
write.csv(responses, paste0("../data/NE_decoded_vulnerability.csv"))
```

