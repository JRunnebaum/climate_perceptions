---
title: "vulnerability comparisons"
author: "Laura"
date: "3/18/2021"
output: html_document
---

##Investigating differences between options for calculating exposure, sensitivity, and adaptive capacity.

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(ggpubr)
library(PNWColors)
library(GGally)
# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```

```{r data}
responses <- read.csv("../data/PNW_decoded_vulnerability.csv")
```

##inital exposure calcuation was respones for all fisheries
##what is we use just the response from the fisheries they participate in?

```{r}
exposure_exploration<-responses%>%
  select(record, CPS, dungeness_crab, groundfish, hake, HMS, salmon, scallops, urchin, shrimp, squid, other,  CPS_warming, dc_warming, gf_warming, hake_warming, hms_warming, salmon_warming,
        scallop_warming,    urchin_warming, shrimp_warming, squid_warming, other_warming)

exposure_exploration[,2:23]<-sapply(exposure_exploration[,2:23], as.numeric)

#probably a better way to do this but it works
#selecting for the exposure scores just for the fisheries people participate in

#CPS
CPSex <- exposure_exploration %>%
  filter(CPS == 1) %>%
  select(record, CPS_warming)
CPSex$CPS_ex = CPSex$CPS_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(CPSex)

#dungy crab
DCex <- exposure_exploration %>%
  filter(dungeness_crab == 1) %>%
  select(record, dc_warming)
DCex$DC_ex = DCex$dc_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(DCex)

#groundfish
gfex <- exposure_exploration %>%
  filter(groundfish == 1) %>%
  select(record, gf_warming)
gfex$gf_ex = gfex$gf_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(gfex)

#hake
hakeex <- exposure_exploration %>%
  filter(hake == 1) %>%
  select(record, hake_warming)
hakeex$hake_ex = hakeex$hake_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(hakeex)

#HMS
hmsex <- exposure_exploration %>%
  filter(HMS == 1) %>%
  select(record, hms_warming)
hmsex$hms_ex = hmsex$hms_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(hmsex)

#salmon
salmonex <- exposure_exploration %>%
  filter(salmon == 1) %>%
  select(record, salmon_warming)
salmonex$salmon_ex = salmonex$salmon_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(salmonex)

#scallops
scallopsex <- exposure_exploration %>%
  filter(scallops == 1) %>%
  select(record, scallop_warming)
scallopsex$scallops_ex = scallopsex$scallop_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(scallopsex)

#urchin
urchinex <- exposure_exploration %>%
  filter(urchin == 1) %>%
  select(record, urchin_warming)
urchinex$urchin_ex = urchinex$urchin_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(urchinex)

#shrimp
shrimpex <- exposure_exploration %>%
  filter(shrimp == 1) %>%
  select(record, shrimp_warming)
shrimpex$shrimp_ex = shrimpex$shrimp_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(shrimpex)

#squid
squidex <- exposure_exploration %>%
  filter(squid == 1) %>%
  select(record, squid_warming)
squidex$squid_ex = squidex$squid_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(squidex)

exposure_exploration$fishery_specific_exposure<-rowMeans(exposure_exploration[,24:33], na.rm = TRUE)

#merge to responses for comparison

responses$fishery_specific_exposure = exposure_exploration$fishery_specific_exposure

```
#exploring differences between exposure methods
```{r}

#visualize how peoples scores differed
ex_types<-responses %>%
  select(X, indv_exposure, fishery_specific_exposure)


library(reshape2)
ex_types_long<-melt(ex_types, id.vars = "X")


group_by(ex_types_long, variable) %>%
  summarise(
    count = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE)
  )

library("ggpubr")
ggboxplot(ex_types_long, x = "variable", y = "value", 
          color = "variable", palette = c("#00AFBB", "#E7B800"))

install.packages("PairedData")
library(PairedData)
#plot paired data
avg_ex <- subset(ex_types_long,  variable == "indv_exposure", value,
                 drop = TRUE)
# subset weight data after treatment
fishsp_ex <- subset(ex_types_long,  variable == "fishery_specific_exposure", value,
                 drop = TRUE)
# Plot paired data

pd <- paired(avg_ex, fishsp_ex)
plot(pd, type = "profile")

#are there differences between the exposure values?
#see if the differences are normally distributed
d <- with(ex_types_long, 
        value[variable == "indv_exposure"] - value[variable == "fishery_specific_exposure"])
# Shapiro-Wilk normality test for the differences
shapiro.test(d)

#data are not normally distributed W = 0.91769, p-value = 0.0000001293
#test difference with paired wilcoxon test

exp_test<-wilcox.test(avg_ex, fishsp_ex, paired = TRUE, na.rm =TRUE)
exp_test

exp_test2<-wilcox.test(value ~ variable, data = ex_types_long, paired=TRUE, na.rm = TRUE)
exp_test2
          
exposure_comparisons<-ggplot(ex_types_long, aes(x=X,y=value,fill=variable))+
     geom_bar(stat="identity",position="dodge")

ggsave(plot = exposure_comparisons, file = paste0("../figures/vulnerability/exposure_comparison.png"))
```