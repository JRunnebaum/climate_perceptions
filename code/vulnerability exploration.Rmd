---
title: "vulnerability comparisons"
author: "Laura"
date: "3/18/2021"
output: html_document
---

##Investigating differences between options for calculating exposure, sensitivity, and adaptive capacity.

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(ggpubr)
library(PNWColors)
library(GGally)
library(NbClust)
# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```

```{r data}
responses <- read.csv("../data/PNW_decoded_vulnerability.csv")
```


##subsetting by fishery
```{r Option 1: subset by a fishery}

#creates a dataframe of everyone who fishes in a specific fishery
#index essentially placeholder
#change q1r2 for whatever fishery you want to look at
index = which(responses$dungeness_crab == 1) #q1r2 is fishing for dungeness crab
# if you changed column names, used the appropriate column name
dungycrab = responses[index,]

#summary of fishery that has been subsetted
dungycrab %>%
  group_by(vessel) %>%
  dplyr::summarise(mean = mean(indv_vulnerability),
                   count = n(),
                   sd = sd(indv_vulnerability)
  )
##save DC data for closer analysis
write.csv(dungycrab, "DC_data.csv")
```
##subset by region
```{r Option 1: subset by region fished}

#empty matrix for regional vulnerability numbers
regionmatrix = matrix(NA, nrow = 7, ncol = 6)
colnames(regionmatrix) <- c("region", "avg_exposure", "avg_sensitivity", "avg_ac", "avg_risk", "avg_vulnerability")
regionmatrix[,1] = c("pugetsound_SJF", "wa_coast", "cr", "or_coast", "norcal",
                         "cencal", "socal")

#index essentially placeholder
#change q1r2 for whatever fishery you want to look at
index = which(responses$pugetsound_SJF == 1) #q1r2 is fishing for dungeness crab
# if you changed column names, used the appropriate column name
ps_sjf = responses[index,]

```

#exploring differences between exposure methods
```{r}

#do some tests and visualize how peoples exposure scores differed when you do all fisheries vs just the ones they participate in

#select ID and both exposure scores
ex_types<-responses %>%
  select(X, indv_exposure, fishery_specific_exposure)

#transform dataframe from wide to long
library(reshape2)
ex_types_long<-melt(ex_types, id.vars = "X")

#summary stats
group_by(ex_types_long, variable) %>%
  summarise(
    count = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE)
  )

#boxplot of exposure scores
library("ggpubr")
ggboxplot(ex_types_long, x = "variable", y = "value", 
          color = "variable", palette = c("#00AFBB", "#E7B800"))

#paired boxplot
#messy for all, might be interesting to look at on a per fishery basis or some other subset
#install.packages("PairedData")
library(PairedData)
#subset data into different exposure calculations
avg_ex <- subset(ex_types_long,  variable == "indv_exposure", value,
                 drop = TRUE)
fishsp_ex <- subset(ex_types_long,  variable == "fishery_specific_exposure", value,
                 drop = TRUE)
pd <- paired(avg_ex, fishsp_ex)
plot(pd, type = "profile")

#are there differences between the exposure values?
#start by seeing if the differences are normally distributed
d <- with(ex_types_long, 
        value[variable == "indv_exposure"] - value[variable == "fishery_specific_exposure"])
# Shapiro-Wilk normality test for the differences
shapiro.test(d)

#in PNW data are not normally distributed W = 0.91769, p-value = 0.0000001293
#test difference with paired wilcoxon test
#use t test if differences are normally distributed

#two ways to do the wilcox test
exp_test<-wilcox.test(avg_ex, fishsp_ex, paired = TRUE, na.rm =TRUE)
exp_test

exp_test2<-wilcox.test(value ~ variable, data = ex_types_long, paired=TRUE, na.rm = TRUE)
exp_test2

#pairwise barplot
#also too much data to be useful but could be subsetted
exposure_comparisons<-ggplot(ex_types_long, aes(x=X,y=value,fill=variable))+
     geom_bar(stat="identity",position="dodge")

ggsave(plot = exposure_comparisons, file = paste0("../figures/vulnerability/exposure_comparison.png"))
```

##inital exposure calcuation was respones for all fisheries
##what is we use just the response from the fisheries they participate in?

```{r}
#make data frame of just responses about what fisheries participated in and the responses about climate impacts on fisheries

exposure_exploration<-responses%>%
  select(record, CPS, dungeness_crab, groundfish, hake, HMS, salmon, scallops, urchin, shrimp, squid, other, species, CPS_warming, dc_warming, gf_warming, hake_warming, hms_warming, salmon_warming,
        scallop_warming,    urchin_warming, shrimp_warming, squid_warming, other_warming)

#all but ID column and other species list to numeric
exposure_exploration[,2:12]<-sapply(exposure_exploration[,2:12], as.numeric)
exposure_exploration[,14:24]<-sapply(exposure_exploration[,14:24], as.numeric)

#probably a better way to do this but it works
#go through fishery by fishery
#selecting for the exposure scores just for the fisheries people participate in and save as new column named for fishery and exposure "____ex"

#CPS
CPSex <- exposure_exploration %>%
  filter(CPS == 1) %>%
  select(record, CPS_warming)
CPSex$CPS_ex = CPSex$CPS_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(CPSex)

#dungy crab
DCex <- exposure_exploration %>%
  filter(dungeness_crab == 1) %>%
  select(record, dc_warming)
DCex$DC_ex = DCex$dc_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(DCex)

#groundfish
gfex <- exposure_exploration %>%
  filter(groundfish == 1) %>%
  select(record, gf_warming)
gfex$gf_ex = gfex$gf_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(gfex)

#hake
hakeex <- exposure_exploration %>%
  filter(hake == 1) %>%
  select(record, hake_warming)
hakeex$hake_ex = hakeex$hake_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(hakeex)

#HMS
hmsex <- exposure_exploration %>%
  filter(HMS == 1) %>%
  select(record, hms_warming)
hmsex$hms_ex = hmsex$hms_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(hmsex)

#salmon
salmonex <- exposure_exploration %>%
  filter(salmon == 1) %>%
  select(record, salmon_warming)
salmonex$salmon_ex = salmonex$salmon_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(salmonex)

#scallops
scallopsex <- exposure_exploration %>%
  filter(scallops == 1) %>%
  select(record, scallop_warming)
scallopsex$scallops_ex = scallopsex$scallop_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(scallopsex)

#urchin
urchinex <- exposure_exploration %>%
  filter(urchin == 1) %>%
  select(record, urchin_warming)
urchinex$urchin_ex = urchinex$urchin_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(urchinex)

#shrimp
shrimpex <- exposure_exploration %>%
  filter(shrimp == 1) %>%
  select(record, shrimp_warming)
shrimpex$shrimp_ex = shrimpex$shrimp_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(shrimpex)

#squid
squidex <- exposure_exploration %>%
  filter(squid == 1) %>%
  select(record, squid_warming)
squidex$squid_ex = squidex$squid_warming 

exposure_exploration <- exposure_exploration %>%
  left_join(squidex)

#pulling out the species that are in the other column

#sea cucumber
cukesex<-exposure_exploration %>%
  filter(grepl("sea cucumber", species)) %>%
  select(record, other_warming)
cukesex$cukes_ex = cukesex$other_warming

exposure_exploration <- exposure_exploration %>%
  left_join(cukesex)

#geoduck
geoduckex<-exposure_exploration %>%
  filter(grepl("geoduck", species)) %>%
  select(record, other_warming)
geoduckex$geoduck_ex = geoduckex$other_warming

exposure_exploration <- exposure_exploration %>%
  left_join(geoduckex)

#razor clam
rcex<-exposure_exploration %>%
  filter(grepl("razor clam", species)) %>%
  select(record, other_warming)
rcex$rc_ex = rcex$other_warming

exposure_exploration <- exposure_exploration %>%
  left_join(rcex)

#halibut
halibutex<-exposure_exploration %>%
  filter(grepl("halibut", species)) %>%
  select(record, other_warming)
halibutex$halibut_ex = halibutex$other_warming

exposure_exploration <- exposure_exploration %>%
  left_join(halibutex)

#wrap of the rest of the random responses together
otherex<-exposure_exploration %>%
  filter(grepl("oysters|smelt|black cod|albacore|sea bass|sablefish|crawfish", species)) %>%
  select(record, other_warming)
otherex$other_ex = otherex$other_warming

exposure_exploration <- exposure_exploration %>%
  left_join(otherex)

exposure_exploration$fishery_specific_exposure<-rowMeans(exposure_exploration[,24:39], na.rm = TRUE)

#merge to responses for comparison

responses$fishery_specific_exposure = exposure_exploration$fishery_specific_exposure

```
#clustering by vulnerability scores instead of concerns
```{r}
vs<-responses %>%
  select(indv_exposure, indv_sensitivity, indv_ac)

#cluster
NbClust(vs, distance = "euclidean", min.nc = 2, max.nc = 10, method = "complete", index = "alllong")

#recommends 4 clusters

#do the clustering
#computational costs = 4 mint milanos
d<-dist(vs, method = "euclidean")
con_cluster<-hclust(d, method = "ward")
groups<-cutree(con_cluster, k=3)
vs<-cbind(vs, groups)
vs$groups<-as.factor(vs$groups)

plot(con_cluster)
ggdendrogram(con_cluster)

vs$risk = responses$risk_euc

quad_plot<-ggplot(vs, aes(x = indv_ac, y = risk, color = groups)) + 
  geom_count() +
  xlim(0,1) + ylim(0,1) +
  geom_hline(yintercept = .5) +
  geom_vline(xintercept = .5) +
  xlab("Average Adaptive Capacity") +
  ylab("Average Risk") +
  scale_x_reverse()

quad_plot

```
```