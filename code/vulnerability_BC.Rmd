---
title: "Vulnerability calculations"
author: "Laura"
date: "11/30/2020"
output: word_document
---

##Investigating how people said climate would impact fisheries and using those responses to get to a value of exposure.

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```

```{r data}
responses <- read.csv("../data/decoded_responses_07.Dec.2020.csv")
```

```{r functions}
#giving exposure a scale of -1 to 1, where a fishery that will be strongly negatively affected by climate change scores a 1. Higher score means higher exposure.
exposure_calc <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strong_neg"){
  return(1)
} else if(x == "slight_neg"){
  return(0.5)
} else if(x == "no_effect"){
  return(0)
} else if (x == "slight_pos"){
  return(-0.5)
} else if (x == "strong_pos"){
  return(-1)
} else if (x == "idk") {
  return("NA")
}
}

#Recoding likert answers on a scale of 1 to -1 where strongly agree equals 1. To be applied for sensitity and adaptive capacity or other applicable situations.
sensitivity_ac <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strongly_agree"){
  return(1)
} else if(x == "somewhat_agree"){
  return(.5)
} else if(x == "neutral"){
  return(0)
} else if (x == "somewhat_disagree"){
  return(-0.5)
} else if (x == "strongly_disagree"){
  return(-1)
} else if (x == "I have not observed any changes") {
  return("NA")
}
}

#Recoding likert in opposite for two inverse adaptive capcity questions, strongly agree equals 1 and higher score equals higher adaptive
ac_scale <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strongly_agree"){
  return(-1)
} else if(x == "somewhat_agree"){
  return(-.5)
} else if(x == "neutral"){
  return(0)
} else if (x == "somewhat_disagree"){
  return(.5)
} else if (x == "strongly_disagree"){
  return(1)
} else if (x == "I have not observed any changes") {
  return("NA")
}
}
```

##changing from likert responses to numbers in order to calculate exposure index
```{r changing responses for exposure index}
responses <- responses %>% 
  mutate(salmon_warming = sapply(X=responses$salmon_warming, FUN=exposure_calc),
         
         herr_warming = sapply(X=responses$herr_warming, FUN=exposure_calc),
        
         albacore_warming = sapply(X=responses$albacore_warming, FUN=exposure_calc),
         
         sardine_warming = sapply(X=responses$sardine_warming, FUN=exposure_calc),
         
         hake_warming = sapply(X=responses$hake_warming, FUN=exposure_calc),
         
         gf_trawl_warming = sapply(X=responses$gf_trawl_warming, FUN=exposure_calc),
         
         halibut_warming = sapply(X=responses$halibut_warming, FUN=exposure_calc),
         
         lingcod_warming = sapply(X=responses$lingcod_warming, FUN=exposure_calc),
         
         dogfish_warming = sapply(X=responses$dogfish_warming, FUN=exposure_calc),
         
         sable_warming = sapply(X=responses$sable_warming, FUN=exposure_calc),
         
         rock_warming = sapply(X=responses$rock_warming, FUN=exposure_calc),
         
         shrimp_warming = sapply(X=responses$shrimp_warming, FUN=exposure_calc),
         
         prawn_warming = sapply(X=responses$prawn_warming, FUN=exposure_calc),
         
         crab_warming = sapply(X=responses$crab_warming, FUN=exposure_calc),
         
         geo_hc_warming = sapply(X=responses$geo_hc_warming, FUN=exposure_calc),
         
         rsu_warming = sapply(X=responses$rsu_warming, FUN=exposure_calc),
         
         gsu_warming = sapply(X=responses$gsu_warming, FUN=exposure_calc),
         
         cuke_warming = sapply(X=responses$cuke_warming, FUN=exposure_calc),
         
         sockeye_warming = sapply(X=responses$sockeye_warming, FUN=exposure_calc),
         
         coho_warming = sapply(X=responses$coho_warming, FUN=exposure_calc),
         
         chum_warming = sapply(X=responses$chum_warming, FUN=exposure_calc),
         
         chinook_warming = sapply(X=responses$chinook_warming, FUN=exposure_calc),
         
         pink_warming = sapply(X=responses$pink_warming, FUN=exposure_calc))
```

##Perceptions of how will climate affect specific fisheries?
```{r average exposure score for each fishery}
fishery_exposure<-responses %>%
        select(salmon_warming, herr_warming, albacore_warming, sardine_warming, hake_warming, other_warming)

#fishery exposure as the average of all the responses for that fishery
fishery_exposure<-as.data.frame(sapply(fishery_exposure, as.numeric))
fishery_avg_exposure<-colMeans(fishery_exposure, na.rm = TRUE)
fishery_avg_exposure<-as.data.frame(fishery_avg_exposure)
fishery_avg_exposure$sd = apply(fishery_exposure, 2, sd, na.rm=TRUE)

write.csv(fishery_avg_exposure, "fisheryexposure.csv")


#if we consider an inviduals exposure to be the average of their responses for all fisheries
individual_exposure<-rowMeans(fishery_exposure, na.rm = TRUE)
responses$indv_exposure = individual_exposure

```

##sensitivity index
```{r sensitivity calculation}
#q38 Please agree or disagree with statements describing how changes in the environment and fisheries have affected your health and wellbeing

responses <- responses %>% 
  mutate(fish_neg_wellbeing = sapply(X=responses$fish_neg_wellbeing, FUN=sensitivity_ac),
         fish_neg_health = sapply(X=responses$fish_neg_health, FUN = sensitivity_ac),
         fish_neg_mental = sapply(X=responses$fish_neg_mental, FUN = sensitivity_ac),
         fish_increase_stress = sapply(X=responses$fish_increase_stress, FUN = sensitivity_ac),
         env_neg_welbeing = sapply(X=responses$fish_neg_wellbeing, FUN = sensitivity_ac),
         env_neg_health = sapply(X=responses$env_neg_health, FUN = sensitivity_ac),
         env_neg_mental = sapply(X=responses$env_neg_mental, FUN = sensitivity_ac),
         env_increase_stress = sapply(X=responses$env_increase_stress, FUN = sensitivity_ac),
         env_neg_safety = sapply(X=responses$env_neg_safety, FUN = sensitivity_ac))

#if we consider an inviduals sensitivity to be the average of their responses for q38
sens_index<-responses%>%
  select(fish_neg_health, fish_neg_mental, fish_neg_wellbeing, fish_increase_stress, env_neg_health, env_neg_mental, env_neg_safety, env_neg_welbeing, env_increase_stress)
sens_index<-as.data.frame(sapply(sens_index, as.numeric))
responses$indv_sensitivity<-rowMeans(sens_index, na.rm = TRUE)
```

##visualizing risk (exposure v sensitivity) of individuals
```{r risk plot}

risk_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity)) +
  geom_point()
risk_plot

ggsave(plot = risk_plot, file = paste0("../figures/vulnerability/indv_risk.png"))

#looking at risk by age
risk_age_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = age)) +
  geom_point()
risk_age_plot

ggsave(plot = risk_age_plot, file = paste0("../figures/vulnerability/risk_age.png"))

#risk by how much income you get from fishing
risk_income_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = income)) +
  geom_point() +
  ggtitle("Risk and percentage of income from outside of fishing")
risk_income_plot

ggsave(plot = risk_income_plot, file = paste0("../figures/vulnerability/risk_income.png"))

#risk by state
#riskpct_state_plot<-ggplot(responses, aes(x=individual_ex_pctrank, y=indv_sensitivity_pctrank, color = state_code)) +
  #geom_point() +
  #ggtitle("Risk and state of residence")
#riskpct_state_plot

#ggsave(plot = riskpct_state_plot, file = paste0("../figures/vulnerability/risk_state_pctrank.png"))


```
##adaptive capacity
```{r adapative capacity calculation}
#q42 With regard to the future security of yourself, your residential community, or your fishery, please indicate the extent to which you agree or disagree with the following statements. Most statements worded so that agreeing = higher adaptive capacity. r7 and r9 are the inverse, agreeing = lower adaptive capacity. 

#rescoring note where different function is needed
responses <- responses %>% 
  mutate(new_fishery = sapply(X=responses$new_fishery, FUN=sensitivity_ac),
         nat_resource_job = sapply(X=responses$nat_resource_job, FUN=sensitivity_ac),
         other_job = sapply(X=responses$other_job, FUN=sensitivity_ac),
         loan = sapply(X=responses$loan, FUN=sensitivity_ac),
         distance = sapply(X=responses$distance, FUN=sensitivity_ac),
         strong_comm = sapply(X=responses$strong_comm, FUN=sensitivity_ac),
         climate_refugees = sapply(X=responses$climate_refugees, FUN=ac_scale),
         adapt_mgmt = sapply(X=responses$adapt_mgmt, FUN=sensitivity_ac),
         const_reg = sapply(X=responses$const_reg, FUN=ac_scale))

#if we consider an inviduals adaptive capacity to be the average of their responses for q42
ac_index<-responses%>%
  select(new_fishery, nat_resource_job, other_job, loan, distance, strong_comm, climate_refugees, adapt_mgmt, const_reg)
ac_index<-as.data.frame(sapply(ac_index, as.numeric))
responses$indv_ac<-rowMeans(ac_index, na.rm = TRUE)

```
##vulnerability
```{r vulnerability}
#putting exposure, sensitivity, and ac together
#starting with v = e + s - ac

#for scatterplot e + s = risk
risk<-cbind(responses$indv_exposure, responses$indv_sensitivity)
responses$indv_risk = rowSums(risk, na.rm = TRUE)

#plot risk against inverse of ac
indv_vulnerability_plot<-ggplot(responses, aes(x=(1 - indv_ac), y=indv_risk)) +
  geom_point() +
  ggtitle("Individual Vulnerability")
indv_vulnerability_plot

ggsave(plot = indv_vulnerability_plot, file = paste0("../figures/vulnerability/indv_vulnerability.png"))

#vulnerability if you use euclidean distance to find risk
responses$indv_risk_euc<-sqrt(responses$indv_exposure^2 + responses$indv_sensitivity^2)
vulnerability_euc_plot<-ggplot(responses, aes(x=(1 - indv_ac), y=indv_risk_euc)) +
  geom_point() +
  ggtitle("Vulnerability using euclidean distance for risk")
vulnerability_euc_plot

ggsave(plot = vulnerability_euc_plot, file = paste0("../figures/vulnerability/vulnerability_euc.png"))

#exploring how the two risk methods compare
risk_rank<-rank(responses$indv_risk)
risk_pct_rank<-rank(indv_risk_pct)
risk_euc_rank<-rank(responses$indv_risk_euc)
risk_diff<-risk_pct_rank-risk_euc_rank
risk_rankings<-cbind.data.frame(risk_rank, risk_pct_rank, risk_euc_rank, risk_diff)

```

##other potential considerations for exposure
##how will climate affect fisheries?
```{r climate impacts on fisheries}

responses$dc_warming<-factor(responses$dc_warming, levels = c("strong_neg", "slight_neg", "no_effect", "slight_pos", "strong_pos", "idk"))

cc_DC_plot <- ggplot(data = responses, aes (x=dc_warming))+
  geom_bar(fill = "blue", position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 16))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Impacts of ocean warming on Dungeness Crab") 

ggsave(plot = cc_DC_plot, file = paste0("../figures/OR_DC/ccimpacts_DC.png"))
```

##Have you seen changes in the range of your primary fishery?
```{r range shifts}
#q27
responses$range_change<-factor(responses$range_change, levels = c("yes", "no"))

rangeshift_plot <- ggplot(data = responses, aes (x=range_change))+
  geom_bar(fill = "blue", position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 16))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Have you seen range shifts in your primary species") 

ggsave(plot = rangeshift_plot, file = paste0("../figures/rangeshift.png"))
```

##have you seen changes in the timing of when you fish?
```{r timing shifts}
#q29
responses$timing_change<-factor(responses$timing_change, levels = c("yes", "no"))

timeshift_plot <- ggplot(data = responses, aes (x=timing_change))+
  geom_bar(fill = "blue", position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 16))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Has the timing of your fishing season changed?") 

ggsave(plot = timeshift_plot, file = paste0("../figures/timeshift.png"))
```
#adaptive capacity index
```{r adaptive capacity}
#q43

