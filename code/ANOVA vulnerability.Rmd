---
title: "ANOVAs for vulnerability"
author: "Jocelyn"
date: "12/12/2022"
output: word_document
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE, error=FALSE)
```


```{r include=FALSE}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(ggpubr)
library(PNWColors)
library(GGally)
library(hrbrthemes)
library(viridis)
library(vcd)
library(reshape2)
library(car)
library(likert)
library(lsmeans)
library(vcd)

# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```
#load data
#need to have run vulnerability code before this
```{r data, include=FALSE}
responses <- read.csv("data/NE_decoded_vulnerability.csv")
```

#color palettes by how many categories there are
```{r}
pal3 <- pnw_palette("Bay", 3, type = "discrete")
pal4 <- pnw_palette("Bay", 4, type = "discrete") #this was pal
pal5 <- pnw_palette("Bay", 5, type = "discrete")
pal6 <- pnw_palette("Bay", 6, type = "continuous")
pal7 <- pnw_palette("Bay", 7, type = "continuous")
```

##varibility in vulnerability depending on if you think climate change is happening or not
```{r echo=TRUE}
responses$believecat = responses$believe
responses <- responses %>% 
  mutate(believecat = case_when(
    believecat == "strongly_agree" ~ "agree",
    believecat == "somewhat_agree" ~ "agree",
    believecat == "neutral" ~ "neutral",
    believecat == "somewhat_disagree" ~ "disagree", 
    believecat == "strongly_disagree" ~ "disagree"))

#components of vulnerability and belief in climate change
belief_summary <- responses %>%
  group_by(believecat) %>%
  dplyr::summarise(meanex = mean(indv_exposure, na.rm = TRUE),
                   sdex = sd(indv_exposure, na.rm = TRUE),
                   meansen = mean(indv_sensitivity, na.rm = TRUE),
                   sdsen = sd(indv_sensitivity, na.rm = TRUE),
                   meanac = mean(indv_ac, na.rm = TRUE),
                   sdac = sd(indv_ac, na.rm = TRUE),
                   meanvuln = mean(indv_vulnerability_euc, na.rm = TRUE),
                   sdvuln = sd(indv_vulnerability_euc, na.rm = TRUE),
                   count = n())

belief_vuln<-ggboxplot(responses, x = "believecat", y = "indv_vulnerability_euc",
          color = "believecat", palette = pal3,
          order = c("disagree", "neutral", "agree"),
          ylab = "vulnerability", xlab = "I believe climate change is occuring")

belief_vuln
```
#investigating differences in vulnerability
```{r}
#anova
beliefvuln_aov<-aov(indv_vulnerability_euc ~ believecat, data = responses)
summary(beliefvuln_aov)

#1) are the variances homogenous?
#are the variances homogenous? #violated
plot(beliefvuln_aov, 1)
leveneTest(indv_vulnerability_euc ~ believecat, data = responses)
#if not, use welch one way test



#tukey HSD of vulnerability
beliefvuln_tukey<-TukeyHSD(beliefvuln_aov)
beliefvuln_tukey
#test for assumptions about anovas
#this is the only place this is coded but should be added where ever the stats may be used outside of exploration

#if not, use welch one way test
oneway.test(indv_vulnerability_euc ~ believecat, data = responses)
#pairwise t.test with no assumption of equal variances
pairwise.t.test(responses$indv_vulnerability_euc, responses$believecat,
                 p.adjust.method = "BH", pool.sd = FALSE)
#is the data normally distributed?
plot(beliefvuln_aov, 2)
#confirm with shapiro-wilk test on anova residuals
# Extract the residuals
aov_residuals <- residuals(object = beliefvuln_aov )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals )
kruskal.test(indv_vulnerability_euc ~ believecat, data = responses)
pairwise.wilcox.test(responses$indv_vulnerability_euc, responses$believecat,
                 p.adjust.method = "BH")

```


```{r}

##varibility in vulnerability depending on if you think climate change is happening or not
##condensed categories (3 total)
```{r echo=TRUE}
responses$believecat = responses$believe
responses <- responses %>% 
  mutate(believecat = case_when(
    believecat == "strongly_agree" ~ "agree",
    believecat == "somewhat_agree" ~ "agree",
    believecat == "neutral" ~ "neutral",
    believecat == "somewhat_disagree" ~ "disagree", 
    believecat == "strongly_disagree" ~ "disagree"))
#components of vulnerability and belief in climate change
belief_summary <- responses %>%
  group_by(believecat) %>%
  dplyr::summarise(meanex = mean(indv_exposure, na.rm = TRUE),
                   sdex = sd(indv_exposure, na.rm = TRUE),
                   meansen = mean(indv_sensitivity, na.rm = TRUE),
                   sdsen = sd(indv_sensitivity, na.rm = TRUE),
                   meanac = mean(indv_ac, na.rm = TRUE),
                   sdac = sd(indv_ac, na.rm = TRUE),
                   meanvuln = mean(indv_vulnerability_euc, na.rm = TRUE),
                   sdvuln = sd(indv_vulnerability_euc, na.rm = TRUE),
                   count = n())
belief_summary
responses$believecat <- factor(responses$believecat, levels = c("disagree", "neutral", "agree"))


belief_vuln<- ggplot(data=responses, aes(x=believecat, y=indv_vulnerability_euc))+
  geom_boxplot(color = c("#FC4E07", "#E7B800",  "#00AFBB"),
               order = c("disagree", "neutral", "agree"))+
   theme( axis.title = element_text(size = 20), axis.text = element_text(size = 16)) +
   ylab("vulnerability\n") +
   xlab("I believe climate change is occuring\n")

belief_vuln

ggsave(plot = belief_vuln,  height = 8, width = 10, file = paste0("../figures/vulnerability_ms_figs/Figure4_belief_vuln.png"))

#vulnerability
#ANOVA
beliefvuln_aov<-aov(indv_vulnerability_euc ~ believecat, data = responses)
summary(beliefvuln_aov)

#test for ANOVA assumptions
#this is the only place this is coded but should be added where ever the stats may be used outside of exploration

#1) are the variances homogenous? #no, they are violated for the NE
plot(beliefvuln_aov, 1)
leveneTest(indv_vulnerability_euc ~ believecat, data = responses) #assumption violated 
#if not, use welch one way test

#2) is the data normally distributed? #yes, normally distributed
plot(beliefvuln_aov, 2)
#confirm with shapiro-wilk test on anova residuals
# Extract the residuals
aov_residuals <- residuals(object = beliefvuln_aov )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals ) #yes

#Need to relax ANOVA assumption of homogeneity of variance for belief data
oneway.test(indv_vulnerability_euc ~ believecat, data = responses)
#pairwise t.test with no assumption of equal variances
pairwise.t.test(responses$indv_vulnerability_euc, responses$believecat,
                 p.adjust.method = "BH", pool.sd = FALSE)

#Need to use Kruskal-Wallace for other variables because assumption aren't met for them
kruskal.test(indv_vulnerability_euc ~ believecat, data = responses)

```

###ANOVAs and pairwise t-tests for exposure, sensitivity, and adaptive capacity

#exposure
```{r}

#ANOVA
#anova exposure
beliefex_aov<-aov(indv_exposure ~ believecat, data = responses)
summary(beliefex_aov)

#test for ANOVA assumptions
#this is the only place this is coded but should be added where ever the stats may be used outside of exploration

#1) are the variances homogenous? #no, they are violated for the NE
plot(beliefex_aov, 1)
leveneTest(indv_exposure ~ believecat, data = responses) #assumption violated 
#if not, use welch one way test

#2) is the data normally distributed? #no, not normally distributed
plot(beliefex_aov, 2)
#confirm with shapiro-wilk test on anova residuals
# Extract the residuals
aov_residuals <- residuals(object = beliefex_aov )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals ) #failed

#Need to relax ANOVA assumption of homogeneity of variance for belief data
kruskal.test(indv_exposure ~ believecat, data = responses)
#pairwise t.test with no assumption of equal variances
pairwise.t.test(responses$indv_exposure, responses$believecat,
                 p.adjust.method = "BH", pool.sd = FALSE)


```

#sensitivity
```{r}
#ANOVA
#anova of sensitivity
beliefsen_aov<-aov(indv_sensitivity ~ believecat, data = responses)
summary(beliefsen_aov)
#test for ANOVA assumptions
#this is the only place this is coded but should be added where ever the stats may be used outside of exploration

#1) are the variances homogenous? #no, they are violated for the NE
plot(beliefsen_aov, 1)
leveneTest(indv_sensitivity ~ believecat, data = responses) #assumption violated 
#if not, use welch one way test

#2) is the data normally distributed? #no, not normally distributed
plot(beliefsen_aov, 2)
#confirm with shapiro-wilk test on anova residuals
# Extract the residuals
aov_residuals <- residuals(object = beliefsen_aov )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals ) #failed

#Need to relax ANOVA assumption of homogeneity of variance for belief data
kruskal.test(indv_sensitivity ~ believecat, data = responses)
#pairwise t.test with no assumption of equal variances
pairwise.t.test(responses$indv_sensitivity, responses$believecat,
                 p.adjust.method = "BH", pool.sd = FALSE)


`
``
#adaptive capacity
```{r}

#ANOVA
#anova of adaptive capacity
beliefac_aov<-aov(indv_ac ~ believecat, data = responses)
summary(beliefac_aov)
#test for ANOVA assumptions
#this is the only place this is coded but should be added where ever the stats may be used outside of exploration

#1) are the variances homogenous? #no, they are violated for the NE
plot(beliefac_aov, 1)
leveneTest(indv_ac ~ believecat, data = responses) #assumption violated 
#if not, use welch one way test

#2) is the data normally distributed? #no, not normally distributed
plot(beliefac_aov, 2)
#confirm with shapiro-wilk test on anova residuals
# Extract the residuals
aov_residuals <- residuals(object = beliefac_aov )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals ) #failed

#Need to relax ANOVA assumption of homogeneity of variance for belief data
kruskal.test(indv_ac ~ believecat, data = responses)
#pairwise t.test with no assumption of equal variances
pairwise.t.test(responses$indv_ac, responses$believecat,
                 p.adjust.method = "BH", pool.sd = FALSE)
```





