##Run the vulnerability code in order to have the numbers needed below


### Example 1: subset by a fishery

#index essentially placeholder
#change q1r2 for whatever fishery you want to look at
index <- responses %>% 
  filter(lobster == 1)
index = which(responses$lobster == 1) #q1r2 is fishing for lobster
# if you changed column names, used the appropriate column name
lobster = responses[index,]


### Example 2: or make a new column and specify fishery(ies) for each person
# this will be better for averaging across a fishery

responses$listoffisheries = rep(NA, length =  nrow(responses))
# loop through each person and get what they are fishing for, put in new column
# should list each fishery they fish for
# not beautiful code but works
for(i in 1: nrow(responses)) {
  fisheriesname = ""
  if(responses$lobster[i] == 1) {
    fisheriesname = paste(fisheriesname, "lobster", sep = "") 
  }
  if(responses$groundfish_category[i] == "groundfish") {
    if(fisheriesname == "") { # have to do extra to not put a , at the beginning
      # if this is the first fishery 
      fisheriesname = paste(fisheriesname, "groundfish", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "groundfish", sep = ", ")
    }
  }
  if(responses$groundfish_category[i] == "whiting") {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "whiting", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "whiting", sep = ", ")
    }
  }
  if(responses$herring[i] == 1) {
    if(fisheriesname == "") {
    fisheriesname = paste(fisheriesname, "herring", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "herring", sep = ", ")
    }
  }
  if(responses$menhaden[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "menhaden", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "menhaden", sep = ", ")
    }
  }
  if(responses$scallop[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "scallop", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "scallop", sep = ", ")
    }
  }
  if(responses$skates[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "skates", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "skates", sep = ", ")
    }
  }
  if(responses$red_crab[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "red crab", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "red crab", sep = ", ")
    }
  }
  if(responses$clams[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "clams", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "clams", sep = ", ")
    }
  }
  if(responses$squid[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "squid", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "squid", sep = ", ")
    }
  }
  if(responses$dogfish[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "dogfish", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "dogfish", sep = ", ")
    }
  }
  if(responses$scup[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "scup", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "scup", sep = ", ")
    }
  }
  if(responses$black_seabass[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "black sea bass", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "black sea bass", sep = ", ")
    }
  }
  if(responses$other[i] == 1) {
    if(fisheriesname == "") { 
    fisheriesname = paste(fisheriesname, responses$species[i], sep = "")
    #paste in what the person put for "other"
    }else {
      fisheriesname = paste(fisheriesname, responses$species[i], sep = ", ")
    }
  }
  responses$listoffisheries[i] = fisheriesname
}

### Average across each UNIQUE "fishery" - so if they fish for salmon AND HMS, gets
# treated different than just fishing for salmon
#could use if fuction to pull out whatever "fishery" is desired with this method


library(plyr)
fisheryavg = ddply(responses, c("listoffisheries"), summarise,
                   exposure_avg = mean(individual_ex, na.rm = TRUE),
                   sensitivity_avg    = mean(indv_sensitivity),
                   adaptive_avg = mean(indv_ac)
                   #vuln_avg = mean(vuln)
                   
)

# OR if want average across any that contain a single one - 
fisheryavgmatrix = matrix(NA, nrow = 13, ncol = 2)
fisheryavgmatrix[,1] = c("lobster", "groundfish", "whiting", "herring", "menhaden",
                         "scallop", "skates","red crab", "clams", "squid", "dogfish", "scup", "black sea bass")

#subset to the fishery and avg vulnerability by people who fish for that fishery
for(i in 1:nrow(fisheryavgmatrix)) {
  index = which(grepl(fisheryavgmatrix[i,1], responses$listoffisheries) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  # so for i = 1, this gives you which rows (which fishermen) fish for CPS
  fisheryavgmatrix[i,2] = mean(responses$individual_ex[index], na.rm = TRUE)
  # average vulnerability across any fisherman that fishes that fishery -
  # would need to add columns to the matrix and then calculate avg exposure, avg 
  # sensitivity, etc. 
}

fisheryavgmatrix #see what it looks like - avg vuln looks like its getting 
# treated as a character
as.numeric(fisheryavgmatrix[,2]) # gives you values


####### County #######
# find county and average vulnerability by county
county = read.csv("CommunityCounty2.csv", header = TRUE)
which(tolower(as.character(survey$q4[-91])) %in% tolower(county$City))
survey$county = rep(NA, length = nrow(survey))

for(i in 1:nrow(survey)) {
  if(i == 91) { #weird entry in 91
    name = ""
    tempindex = ""
  } else {
    name = tolower(as.character(survey$q4[i]))
    name = substr(name, start = 1, stop = 6) # hopefully first 6 characters are unique
    # if you correct names and only have the city name (no state abbreviation),
    # could get rid of this second line
    #grepl looks name in your whole list of counties
    tempindex = which(grepl(name, tolower(county$City)))
    if(length(tempindex) == 0) {
      survey$county[i] = NA
    } else if(length(tempindex) == 1) { #since cities are named the same in multiple 
      # states could have a length > 1 
      survey$county[i] = as.character(county$County[tempindex])
    }
  }
}

index = which(is.na(survey$county))
index = which(grepl("aberdeen", tolower(as.character(survey$q4[-91]))) == TRUE) 
survey$county[index] = "Grays Harbor"

#once cleaned up, and county for each, can then average by county
countyavg = ddply(survey, c("county"), summarise,
                   exposure_avg = mean(exposure),
                   sensitivity_avg    = mean(sensitivity),
                   adaptive_avg = mean(adaptive),
                   vuln_avg = mean(vuln)
                   
) # right now is finding an average across all that have county as "NA"
#look for those to spell right or figure out what county that city is in and add to list

