---
title: "Figures for paper"
author: "Laura"
date: "6/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(gridExtra)
#library(ggbiplot)
library(PNWColors)
#library(ggpubr)
library(ggplot2)

# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```

```{r load data}
responses <- read.csv("../data/PNW_decoded_vulnerability13.May.2021.csv")
```

```{r}
#color paletes

pal3<-pnw_palette(name="Sailboat",n=3,type="discrete")
pal4<-pnw_palette(name="Sailboat",n=4,type="discrete")
pal5<-pnw_palette(name="Sailboat",n=5,type="discrete")
pal6<-pnw_palette(name="Sailboat",n=6,type="discrete")
pal7<-pnw_palette(name="Sailboat",n=7,type="continuous")

```
#demographic numbers for table 1 in results
```{r}

table(responses$state_code)
table(responses$yrs_fishing)
table(responses$yrs_residence)
table(responses$age)
table(responses$income)
table(responses$ocean_temp)
table(responses$target_spp)
table(responses$range_change)
table(responses$timing_change)
table(responses$ability)
table(responses$concern_groups)
```

```{r}
#q3 regions where people fish
regions <-  responses %>%
  select(pugetsound_SJF, wa_coast, cr, or_coast, norcal, cencal, socal) 

regions <- regions %>%
  rename('Puget Sound and SJF' = pugetsound_SJF,
        'WA Coast' = wa_coast,
        'Columbia River' = cr,
         'OR coast' = or_coast,
         'Northern CA' = norcal,
         'Central CA' = cencal,
         'Southern CA' = socal)   #other_region is also an option
  
  regions <- regions %>% 
  gather(region, response) %>% 
  group_by(region)


regioncount = regions %>% group_by(region) %>%
  dplyr::summarise(sum = sum(response))


region_plot <- ggplot(regioncount, aes(x=region, y = sum)) +
  geom_bar(stat = "identity", fill = pal) +
  ggtitle("Regions Fished\n") + 
  theme(axis.text = element_text(angle = 45, vjust = 0.5, hjust=1), 
        axis.title = element_blank())

region_plot
```
#fisheries
```{r}
fisheries<- responses %>%
  select(CPS, dungeness_crab, groundfish, hake, HMS, salmon, scallops, urchin, shrimp, squid, other)

otherfish<-responses %>%
  select(other, species)


fisheries <- fisheries %>%
  gather(fishery, response) %>%
  group_by(fishery)

fisherycount = read.csv("../data/fisheryparticipation.csv")

fp <- ggplot(fisherycount, aes(x=fishery, y = count)) +
  geom_bar(stat = "identity", fill = pal) +
  ylab("count") +
  ggtitle("Fishery participation\n") + 
  theme(axis.text = element_text(angle = 45, vjust = 0.5, hjust=1)) 
        #axis.title = element_blank())

fp
```

```{r}
job <-  responses %>%
  select(captain, vessel_owner, crew, other_role)%>%
  rename("captain" = captain,
         "vessel owner" = vessel_owner,
         "crew" = crew,
         "other" = other_role)%>%
  gather(role, response) %>% 
  group_by(role)


jobcount = job %>% group_by(role) %>%
  dplyr::summarise(sum = sum(response))

job_plot <- ggplot(jobcount, aes(x=role, y = sum)) +
  geom_bar(stat = "identity", fill = pal) +
  ggtitle("Industry role\n") + 
  theme(axis.text = element_text(angle = 45, vjust = 0.5, hjust=1), 
        axis.title = element_blank())

job_plot
```

```{r}
#put those together

rp<-grid.arrange(arrangeGrob(region_plot, job_plot, ncol = 2), fp, nrow = 2)
rp

ggsave(plot = rp, width = 6, height = 8, file = paste0("../figures/paper/responses.png"))
```

```{r}
belief$ability <- factor(belief$ability, levels = c("no", "no_obs_change", "yes_neg", "yes_pos"))

belief$age <- factor(belief$age, levels = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"))

cc_ability_by_age_plot <- ggplot(data = belief, aes (x=ability, fill = age))+
  geom_bar(position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Climate change has affected ability to catch fish") 

ggsave(plot = cc_ability_by_age_plot, file = paste0("../figures/climate_change_ability_age.png"))

responses$agecat<-as.factor(responses$agecat)

responses <- responses %>% 
  mutate(agecat = case_when(
    agecat == 'U30'|'30-40'|'40-50' ~ "50 or under",
    agecat == '50-60' ~ "50-60",
    agecat == '60-70' ~ "60-70",
    agecat == '70+' ~ "70+"))

recode(responses$agecat, 
    'u30' = "50 or under",
    '30-40' = "50 or under",
    '40-50' = "50 or under",
    '50-60' = "50-60",
    '60-70' = "60-70",
    '70+' = "70+", default = levels(factor_vec))

ccage<-table(responses$ability, responses$age)

chisq.test(ccage)

library(graphics)
mosaicplot(ccage, shade = TRUE, las=2,
           main = "fishing affected")
```

Map making lesson
```{r}
library(raster)
#install.packages("sf")
library(sf)

load(url("https://github.com/mgimond/Spatial/raw/main/Data/Sample1.RData"))

install.packages("tmap")
library(tmap) 
tm_shape(s.sf) + tm_polygons(col="grey", border.col="white")

tm_shape(s.sf) + tm_polygons(col="Income", border.col = "white")
```

```{r}
install.packages("geojsonio")
library(geojsonio)

spdf <- geojson_read("https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/communes.geojson",  what = "sp")

# Since it is a bit too much data, I select only a subset of it:
spdf <- spdf[ substr(spdf@data$code,1,2)  %in% c("06", "83", "13", "30", "34", "11", "66") , ]

#plot(spdf)

# I need to fortify the data AND keep trace of the commune code! (Takes ~2 minutes)
install.packages("broom")
library(broom)
spdf_fortified <- tidy(spdf, region = "code")

# Now I can plot this shape easily as described before:
#library(ggplot2)
ggplot() +
  geom_polygon(data = spdf_fortified, aes( x = long, y = lat, group = group), fill="white", color="grey") +
  theme_void() +
  coord_map()
```
```{r}
#install.packages("maps")
library(maps)
#uscount<-geojson_read("../data/us.json")

help(package='maps')

map("county", c("washington", "oregon", "california"), fill = TRUE, col = pal)
ggplot::map_data("county", c("washington", "oregon", "california"), fill = TRUE, col = pal)
```
