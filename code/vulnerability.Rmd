---
title: "Vulnerability"
author: "Laura Nelson"
date: "11/30/2020"
output: word_document
---

##Investigating perceptions of exposure, sensitivity, and adaptive capacity.

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
```

```{r, packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(grDevices)
library(extrafont)
library(ggrepel)
library(ggthemes)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(ggpubr)
library(PNWColors)
library(GGally)
library(vcd)
# windowsFonts(Times=windowsFont("Calibri"))
theme_sleek <- function(base_size = 12, base_family = "Calibri") {
  half_line <- base_size/2
  theme_light(base_size = 12, base_family = "Calibri") +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks.length = unit(half_line / 2.2, "pt"),
      strip.background = element_rect(fill = NA, colour = NA),
      strip.text.x = element_text(colour = "black"),
      strip.text.y = element_text(colour = "black"),
      # axis.text = element_text(colour = "grey30"),
      #axis.title = element_text(colour = "grey30"),
      #legend.title = element_text(colour = "grey30"),#, size = rel(0.9)
      legend.title = element_blank(),
      panel.border = element_rect(fill = NA),#, colour = "grey70", size = 1),
      legend.key.size = unit(0.9, "lines"),
      #legend.text = element_text(size = rel(0.7)),#, colour = "grey30"),
      legend.key = element_rect(colour = NA, fill = NA),
      legend.background = element_rect(colour = NA, fill = NA)#,
      #plot.title = element_text(colour = "grey30"),#, size = rel(1),
      #plot.subtitle = element_text(colour = "grey30")#, size = rel(.85),
     
      
    )
}
theme_set(theme_sleek())
options(scipen = 999) #turns off scientific notation
# Depends on dplyr
tickr <- function(
  data, # dataframe
  var, # column of interest
  to # break point definition 
){
  
  VAR <- enquo(var) # makes VAR a dynamic variable
  
  data %>% 
    distinct(!!VAR) %>%
    ungroup(!!VAR) %>% 
    mutate(labels = ifelse(!!VAR %in% seq(to * round(min(!!VAR) / to), max(!!VAR), to),
                           !!VAR, "")) %>%
    select(breaks = UQ(VAR), labels)
}
```
#load data with state additions from data exploration
```{r data}
responses <- read.csv("../data/PNW_decoded_responses_wstate10.Feb.2021.csv")
```

#functions to get likert answers to a 0 to 1 scale
```{r functions}
#giving exposure a scale of 0 to 1, where a fishery that will be strongly negatively affected by climate change scores a 1. Higher score means higher exposure.
exposure_calc <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strong_neg"){
  return(1)
} else if(x == "slight_neg"){
  return(0.75)
} else if(x == "no_effect"){
  return(.5)
} else if (x == "slight_pos"){
  return(.25)
} else if (x == "strong_pos"){
  return(0)
} else if (x == "idk") {
  return("NA")
}
}

#Recoding likert answers on a scale of 0 to 1 where strongly agree equals 1. To be applied for sensitity and adaptive capacity or other applicable situations.
sensitivity_ac <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strongly_agree"){
  return(1)
} else if(x == "somewhat_agree"){
  return(.75)
} else if(x == "neutral"){
  return(.5)
} else if (x == "somewhat_disagree"){
  return(.25)
} else if (x == "strongly_disagree"){
  return(0)
} else if (x == "I have not observed any changes") {
  return("NA")
}
}

#Recoding likert in opposite for two inverse adaptive capcity questions, strongly agree equals 1 and higher score equals higher adaptive
ac_scale <- function(x){
if(is.na(x)){
  return("NA")
} else if(x == "strongly_agree"){
  return(0)
} else if(x == "somewhat_agree"){
  return(.25)
} else if(x == "neutral"){
  return(.5)
} else if (x == "somewhat_disagree"){
  return(.75)
} else if (x == "strongly_disagree"){
  return(1)
} else if (x == "I have not observed any changes") {
  return("NA")
}
}
```
##exposure
##changing from likert responses to numbers in order to calculate exposure index
```{r changing responses for exposure index}
responses <- responses %>% 
  mutate(CPS_warming = sapply(X=responses$CPS_warming, FUN=exposure_calc),
         
         dc_warming = sapply(X=responses$dc_warming, FUN=exposure_calc),
        
         gf_warming = sapply(X=responses$gf_warming, FUN=exposure_calc),
         
         hake_warming = sapply(X=responses$hake_warming, FUN=exposure_calc),
         
         hms_warming = sapply(X=responses$hms_warming, FUN=exposure_calc),
         
         salmon_warming = sapply(X=responses$salmon_warming, FUN=exposure_calc),

         scallop_warming = sapply(X=responses$scallop_warming, FUN=exposure_calc),
        
         urchin_warming = sapply(X=responses$urchin_warming, FUN=exposure_calc),
         
         shrimp_warming = sapply(X=responses$shrimp_warming, FUN=exposure_calc),
         
         squid_warming = sapply(X=responses$squid_warming, FUN=exposure_calc),
         
         other_warming = sapply(X=responses$other_warming, FUN=exposure_calc))
```

##Exposure based on perceptions of how will climate affect all fisheries
```{r average exposure score for each fishery}
fishery_exposure<-responses %>%
        select(CPS_warming, dc_warming, gf_warming, hake_warming, hms_warming, salmon_warming,
        scallop_warming,    urchin_warming, shrimp_warming, squid_warming, other_warming)

#fishery exposure as the average of all the responses for that fishery
fishery_exposure<-as.data.frame(sapply(fishery_exposure, as.numeric))
fishery_avg_exposure<-colMeans(fishery_exposure, na.rm = TRUE)
fishery_avg_exposure<-as.data.frame(fishery_avg_exposure)
fishery_avg_exposure$sd = apply(fishery_exposure, 2, sd, na.rm=TRUE)


#if we consider an inviduals exposure to be the average of their responses for all fisheries
individual_exposure<-rowMeans(fishery_exposure, na.rm = TRUE)
responses$indv_exposure_af = individual_exposure

```

##Exposure based upon perceptions of how climate will affect only the fisheries you participate in
##calling other Rmd file with code that calculates exposure that way and adds it to responses as a column called fishery_specific_exposure
```{r}
rmarkdown::render("Fishery specific exposure.Rmd")
```

##sensitivity index
```{r sensitivity calculation}
#q39 Please agree or disagree with statements describing how changes in the environment and fisheries have affected your health and wellbeing

responses <- responses %>% 
  mutate(fish_neg_wellbeing = sapply(X=responses$fish_neg_wellbeing, FUN=sensitivity_ac),
         fish_neg_health = sapply(X=responses$fish_neg_health, FUN = sensitivity_ac),
         fish_neg_mental = sapply(X=responses$fish_neg_mental, FUN = sensitivity_ac),
         fish_increase_stress = sapply(X=responses$fish_increase_stress, FUN = sensitivity_ac),
         env_neg_welbeing = sapply(X=responses$fish_neg_wellbeing, FUN = sensitivity_ac),
         env_neg_health = sapply(X=responses$env_neg_health, FUN = sensitivity_ac),
         env_neg_mental = sapply(X=responses$env_neg_mental, FUN = sensitivity_ac),
         env_increase_stress = sapply(X=responses$env_increase_stress, FUN = sensitivity_ac),
         env_neg_safety = sapply(X=responses$env_neg_safety, FUN = sensitivity_ac))

#if we consider an inviduals sensitivity to be the average of their responses for q39
sens_index<-responses%>%
  select(fish_neg_health, fish_neg_mental, fish_neg_wellbeing, fish_increase_stress, env_neg_health, env_neg_mental, env_neg_safety, env_neg_welbeing, env_increase_stress)
sens_index<-as.data.frame(sapply(sens_index, as.numeric))
responses$indv_sensitivity<-rowMeans(sens_index, na.rm = TRUE)

```

##adaptive capacity
```{r adapative capacity calculation}
#q43 With regard to the future security of yourself, your residential community, or your fishery, please indicate the extent to which you agree or disagree with the following statements. Most statements worded so that agreeing = higher adaptive capacity. r7 and r9 are the inverse, agreeing = lower adaptive capacity. 

#rescoring note where different function is needed
responses <- responses %>% 
  mutate(new_fishery = sapply(X=responses$new_fishery, FUN=sensitivity_ac),
         nat_resource_job = sapply(X=responses$nat_resource_job, FUN=sensitivity_ac),
         other_job = sapply(X=responses$other_job, FUN=sensitivity_ac),
         loan = sapply(X=responses$loan, FUN=sensitivity_ac),
         distance = sapply(X=responses$distance, FUN=sensitivity_ac),
         strong_comm = sapply(X=responses$strong_comm, FUN=sensitivity_ac),
         climate_refugees = sapply(X=responses$climate_refugees, FUN=ac_scale),
         adapt_mgmt = sapply(X=responses$adapt_mgmt, FUN=sensitivity_ac),
         const_reg = sapply(X=responses$const_reg, FUN=ac_scale))

#if we consider an inviduals adaptive capacity to be the average of their responses for q43
ac_index<-responses%>%
  select(new_fishery, nat_resource_job, other_job, loan, distance, strong_comm, climate_refugees, adapt_mgmt, const_reg)
ac_index<-as.data.frame(sapply(ac_index, as.numeric))
responses$indv_ac<-rowMeans(ac_index, na.rm = TRUE)

```

##individual vulnerability
```{r vulnerability}
#putting exposure, sensitivity, and ac together

#invidual risk where r = e + s
#not weighted at all
risk<-cbind(responses$indv_exposure, responses$indv_sensitivity)
responses$indv_risk = rowSums(risk, na.rm = TRUE)

#starting with v = e + s - ac (Cinner 2012)
#same as v = risk - ac
responses$indv_vulnerability = responses$indv_risk - responses$indv_ac

#vulnerability by euclidean distance (Levin and Samhouri 2012)
#risk = sqrt(e^2 + s^2)
#v = sqrt(e^2 + s^2 (1-ac)^2)
responses$risk_euc = sqrt(responses$indv_exposure^2 + responses$indv_sensitivity^2)

#Do inverse of adaptive capacity like Davies (2018) where higher number corresponds to lower adaptive capacity
responses$inverse_ac = 1-responses$indv_ac

#for inverse_ac a higher number equals lower adaptive capacity
#use this for euclidean distance for vulnerability

responses$indv_vulnerability_euc=sqrt(responses$indv_exposure^2 + responses$indv_sensitivity^2 + responses$inverse_ac^2)

#exploring how the two methods compare
#check risk first
risk_rank<-rank(responses$indv_risk, na.last = "keep")
risk_euc_rank<-rank(responses$risk_euc, na.last = "keep")
risk_diff<-risk_rank-risk_euc_rank
risk_rankings<-cbind.data.frame(risk_rank, risk_euc_rank, risk_diff)

#vulnerability differences between methods
vuln_rank<-rank(responses$indv_vulnerability, na.last = "keep")
vuln_euc_rank<-rank(responses$indv_vulnerability_euc, na.last = "keep")
vuln_diff<-vuln_rank-vuln_euc_rank
vuln_rankings<-cbind.data.frame(vuln_rank, vuln_euc_rank, vuln_diff)

allrankings<-cbind.data.frame(risk_rank, risk_euc_rank, risk_diff, vuln_rank, vuln_euc_rank, vuln_diff)

#from here down in this chunk not in master if want to add
#save for vulnerability comparisons
write.csv(allrankings, paste0("../data/vulnerability_comparisons.csv"))

#for a small group of individuals, the method makes a big difference

#look at correlation in ranks

all_ranks<-cbind.data.frame(risk_rank, risk_euc_rank, vuln_rank, vuln_euc_rank)
rank_cor<-cor(all_ranks, use = "complete.obs")
rank_cor
```

#if skipping to vulnerability exploration and figures load this file
```{r}
responses<-read.csv("../data/PNW_decoded_vulnerability.csv")
```

#subsetting by fishery
```{r make a new column and specify fishery(ies) for each person}

#modifed from code written by Laura Koehn
#use to calculate average vulnerability across a fishery
#modify for each survey

responses$listoffisheries = rep(NA, length =  nrow(responses))
# loop through each person and get what they are fishing for, put in new column
# should list each fishery they fish for
# not beautiful code but works
for(i in 1: nrow(responses)) {
  fisheriesname = ""
  if(responses$CPS[i] == 1) {
    fisheriesname = paste(fisheriesname, "CPS", sep = "") 
  }
  if(responses$dungeness_crab[i] == 1) {
    if(fisheriesname == "") { # have to do extra to not put a , at the beginning
      # if this is the first fishery 
      fisheriesname = paste(fisheriesname, "dungeness crab", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "dungeness crab", sep = ", ")
    }
  }
  if(responses$groundfish[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "groundfish", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "groundfish", sep = ", ")
    }
  }
  if(responses$hake[i] == 1) {
    if(fisheriesname == "") {
    fisheriesname = paste(fisheriesname, "hake", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "hake", sep = ", ")
    }
  }
  if(responses$HMS[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "HMS", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "HMS", sep = ", ")
    }
  }
  if(responses$salmon[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "salmon", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "salmon", sep = ", ")
    }
  }
  if(responses$scallops[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "scallops", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "scallops", sep = ", ")
    }
  }
  if(responses$urchin[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "sea urchin", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "sea urchin", sep = ", ")
    }
  }
  if(responses$shrimp[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "shrimp", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "shrimp", sep = ", ")
    }
  }
  if(responses$squid[i] == 1) {
    if(fisheriesname == "") {
      fisheriesname = paste(fisheriesname, "squid", sep = "")
    } else {
      fisheriesname = paste(fisheriesname, "squid", sep = ", ")
    }
  }
  if(responses$other[i] == 1) {
    if(fisheriesname == "") { 
    fisheriesname = paste(fisheriesname, responses$species[i], sep = "")
    #paste in what the person put for "other"
    }else {
      fisheriesname = paste(fisheriesname, responses$species[i], sep = ", ")
    }
  }
  responses$listoffisheries[i] = fisheriesname
}

### Average across each UNIQUE "fishery" - so if they fish for salmon AND HMS, gets
# treated different than just fishing for salmon
#could use if fuction to pull out whatever "fishery" is desired with this method

fisheryavg = responses %>%
  group_by(listoffisheries) %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability),
                   vuln_euc_avg = mean(indv_vulnerability_euc),
                   count = n()
)
```

##average vulnerability by fishery
```{r other ways to subset from Koehn}
#OR if want average across any that contain a single one - 

fisheryavgmatrix = matrix(NA, nrow = 10, ncol = 10)
colnames(fisheryavgmatrix) <- c("fishery", "avg_exposure", "avg_sensitivity", "avg_ac", "ac_sd", "avg_risk", "risk_sd", "avg_risk_euc", "avg_vulnerability", "avg_vulnerabilty_euc")
fisheryavgmatrix[,1] = c("CPS", "dungeness crab", "groundfish", "hake", "HMS",
                         "salmon", "scallops","sea urchin", "shrimp", "squid")

#subset to the fishery and avg vulnerability by people who fish for that fishery
for(i in 1:nrow(fisheryavgmatrix)) {
  index = which(grepl(fisheryavgmatrix[i,1], responses$listoffisheries) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  fisheryavgmatrix[i,2] = mean(responses$indv_exposure[index], na.rm = TRUE)
  fisheryavgmatrix[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  fisheryavgmatrix[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix[i,5] = sd(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix[i,6] = mean(responses$indv_risk[index], na.rm = TRUE)
  fisheryavgmatrix[i,7] = sd(responses$indv_risk[index], na.rm = TRUE)
  fisheryavgmatrix[i,8] = mean(responses$risk_euc[index], na.rm = TRUE)
  fisheryavgmatrix[i,9] = mean(responses$indv_vulnerability[index], na.rm = TRUE)
  fisheryavgmatrix[i,10] = mean(responses$indv_vulnerability_euc[index], na.rm = TRUE)
}

#change to a dataframe and to numeric
fishery_summary<-as.data.frame(fisheryavgmatrix)
fishery_summary[,2:10]<-sapply(fishery_summary[,2:10], as.numeric)
```
##average vulnerability by region

#use the same method as the fisheries to subset by region
```{r make a new column and specify regions(s) for each person}

#modifying from fishery code

responses$listofregions = rep(NA, length =  nrow(responses))
# loop through each person and get what they are fishing for, put in new column
# should list each fishery they fish for
# not beautiful code but works
for(i in 1: nrow(responses)) {
  regionname = ""
  if(responses$pugetsound_SJF[i] == 1) {
    regionname = paste(regionname, "Puget Sound SJF", sep = "") 
  }
  if(responses$wa_coast[i] == 1) {
    if(regionname == "") { # have to do extra to not put a , at the beginning
      # if this is the first fishery 
      regionname = paste(regionname, "WA coast", sep = "")
    } else {
      regionname = paste(regionname, "WA coast", sep = ", ")
    }
  }
  if(responses$cr[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "Columbia River", sep = "")
    } else {
      regionname = paste(regionname, "Columbia River", sep = ", ")
    }
  }
  if(responses$or_coast[i] == 1) {
    if(regionname == "") {
    regionname = paste(regionname, "OR coast", sep = "")
    } else {
      regionname = paste(regionname, "OR coast", sep = ", ")
    }
  }
  if(responses$norcal[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "Nor Cal", sep = "")
    } else {
      regionname = paste(regionname, "Nor Cal", sep = ", ")
    }
  }
  if(responses$cencal[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "Cen Cal", sep = "")
    } else {
      regionname = paste(regionname, "Cen Cal", sep = ", ")
    }
  }
  if(responses$socal[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "So Cal", sep = "")
    } else {
      regionname = paste(regionname, "So Cal", sep = ", ")
    }
  }
  responses$listofregions[i] = regionname
}


regionavg = responses %>%
  group_by(listofregions) %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability),
                   vuln_euc_avg = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
)
```

##average vulnerability by region
```{r}
#grouped by a single regional fishing area
#modify for different surveys

regionmatrix = matrix(NA, nrow = 7, ncol = 8)
colnames(regionmatrix) <- c("region", "avg_exposure", "avg_sensitivity", "avg_ac", "avg_risk", "avg_vulnerability", "avg_risk_euc", "avg_vulnerability_euc")
regionmatrix[,1] = c("Puget Sound SJF", "WA coast", "Columbia River", "OR coast", "Nor Cal",
                         "Cen Cal", "So Cal")

#subset to the fishery and avg vulnerability by people who fish in that area
for(i in 1:nrow(regionmatrix)) {
  index = which(grepl(regionmatrix[i,1], responses$listofregions) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  regionmatrix[i,2] = mean(responses$indv_exposure[index], na.rm = TRUE)
  regionmatrix[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  regionmatrix[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  regionmatrix[i,5] = mean(responses$indv_risk[index], na.rm = TRUE)
  regionmatrix[i,6] = mean(responses$indv_vulnerability[index], na.rm = TRUE)
  regionmatrix[i,7] = mean(responses$risk_euc[index], na.rm = TRUE)
  regionmatrix[i,8] = mean(responses$indv_vulnerability_euc[index], na.rm = TRUE)
}

#change to a dataframe and to numeric
region_summary<-as.data.frame(regionmatrix)
region_summary[,2:8]<-sapply(region_summary[,2:8], as.numeric)
```


#save with vulnerability calculations
```{r}
#change file name as desired
write.csv(responses, paste0("../data/PNW_decoded_vulnerability.csv"))
```

##exploratory figures

#density plots of overall exposure, sensitivity, and ac
#need to add to master
```{r}

comp_vuln<-responses %>%
  select(indv_exposure, indv_sensitivity, indv_ac)

comp_vuln<-melt(comp_vuln)

#mean for each group
mean_vuln<- comp_vuln %>%
  group_by(variable) %>%
  summarise(mean = mean(value, na.rm = TRUE))

mean_vuln

#colors
pal<-pnw_palette("Bay",3)

#plot
cv<-ggplot(comp_vuln, aes(x = value, group = variable, fill = variable))+
             geom_density(alpha = .6)+
  #scale_fill_manual(values = pal) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 3)) +
  geom_vline(data = mean_vuln, aes(xintercept = mean, color = variable)) +
    ggtitle("Distribution of components of vulnerability")+ 
  theme(plot.title = element_text(size = 22), axis.title.x = element_text(size = 16), legend.text = element_text(size = 12), legend.position = "bottom")
cv

ggsave(plot = cv, file = paste0("../figures/vulnerability/components_distribution.png"))

#do people feel differently about the different components?
#each was on a 0 to 1 scale

comp_aov<-aov(value ~ variable, data = comp_vuln)
summary(comp_aov)

TukeyHSD(comp_aov)
```

##replicating the thiault quadrants
```{r}
#choose if you want quadrants determined by mean or median
med_ex<-median(responses$indv_exposure, na.rm = TRUE)
med_ac<-median(responses$indv_ac)

mean_ex<-mean(responses$indv_exposure, na.rm = TRUE)
mean_ac<-mean(responses$indv_ac)

quad_plot<-ggplot(responses, aes(x = indv_ac, y = indv_exposure)) + 
  geom_count() +
  xlim(0,1) + ylim(0,1) +
  geom_hline(yintercept = mean_ex) +
  geom_vline(xintercept = mean_ac) +
  xlab("Average Adaptive Capacity") +
  ylab("Average Exposure") +
  scale_x_reverse()

quad_plot

#who is in the different quadrants?
responses <- responses %>%
  add_column(quadrant = NA)

responses <- responses %>% 
  mutate(quadrant = case_when(
    indv_exposure >= med_ex & indv_ac > med_ac ~ "upper_left",
    indv_exposure >= med_ex & indv_ac <= med_ac ~ "upper_right",
    indv_exposure < med_ex & indv_ac > med_ac ~ "lower_left",
    indv_exposure < med_ex & indv_ac <= med_ac ~ "lower_right"))

#make fewer age groups for comparison
responses%>%group_by(age) %>%
  summarise(count = n())

responses$age_groups<-responses$age

responses <- responses %>% 
  mutate(age_groups = case_when(
    age_groups == "U30" ~ "40 or under",
    age_groups == "30-40" ~ "40 or under",
    age_groups == "40-50" ~ "40-50",
    age_groups == "50-60" ~ "50-60", 
    age_groups == "60-70" ~ "60-70",
    age_groups == "70+" ~ "70+"))

quad_summary <- responses %>%
  group_by(quadrant, age_groups) %>%
  summarise(count = n()) 

table(responses$quadrant)
table(responses$quadrant, responses$age_groups)

chisq.test(table(responses$quadrant, responses$age_groups))

mosaic(~quadrant  + age_groups,
       direction = c("v", "h"),
       data = responses,
       shade = TRUE)

table(responses$quadrant, responses$state_code)
chisq.test(table(responses$quadrant, responses$state_code))

table(responses$quadrant, responses$yrs_fishing)
chisq.test(table(responses$quadrant, responses$yrs_fishing))

table(responses$quadrant, responses$income)
chisq.test(table(responses$quadrant, responses$income))

quad_fishery<-responses%>%
  select(CPS, dungeness_crab, groundfish, hake, HMS, salmon, scallops, urchin, shrimp, squid, other, quadrant)

quad_fishery_sum <-quad_fishery %>% group_by(quadrant) %>%
  summarise(
    cps = sum(CPS),
    dungycrab = sum(dungeness_crab),
    gf = sum(groundfish),
    hake = sum(hake),
    hms = sum(HMS),
    salmon = sum(salmon),
    scallops = sum(scallops),
    urchin = sum(urchin),
    shrimp = sum(shrimp),
    squid = sum(squid),
    other = sum(other))

quad_fishery_sum<-quad_fishery_sum[1:4,]

quad_fishery_sum<-column_to_rownames(quad_fishery_sum, var = "quadrant")
chisq.test(quad_fishery_sum)

fish_bnh_melted<-melt(fish_bnh)

p <- ggplot(fish_bnh_melted, aes(x =variable, y = bnh)) 
p+geom_point( aes(size=value))+theme(panel.background=element_blank(), panel.border = element_rect(colour = "blue", fill=NA, size=1))
```

##visualizing individual risk (exposure v sensitivity)
```{r risk plot}

risk_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity)) +
  geom_point()
risk_plot

ggsave(plot = risk_plot, file = paste0("../figures/vulnerability/risk.png"))

#looking at risk by age
risk_age_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = age)) +
  geom_point()
risk_age_plot

ggsave(plot = risk_age_plot, file = paste0("../figures/vulnerability/risk_age.png"))

#risk by how much income you get from fishing
risk_income_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = income)) +
  geom_point() +
  ggtitle("Risk and percentage of income from outside of fishing")
risk_income_plot

ggsave(plot = risk_income_plot, file = paste0("../figures/vulnerability/risk_income.png"))

#risk by state
risk_state_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = state_code)) +
  geom_point() +
  ggtitle("Risk and state of residence")
risk_state_plot

ggsave(plot = risk_state_plot, file = paste0("../figures/vulnerability/risk_state.png"))

#basic risk vs ac plot by region
region_vulnerability_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk, label = region_summary$region)) +
  geom_point(color = "green") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_plot<-region_vulnerability_plot + scale_x_reverse()

region_vulnerability_plot

ggsave(plot = region_vulnerability_plot, file = paste0("../figures/vulnerability/region_vulnerability.png"))
```

##considering average vulnerability based upon fishery participation
```{r vulnerability}

#basic risk vs ac
fishery_vulnerability_plot<-ggplot(fishery_summary, aes(x=avg_ac, y=avg_risk)) +
  geom_point() + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") +
  ggtitle("Average vulnerability of fishery participants") +
  geom_text(label = fishery_summary$fishery, nudge_y = .01)
fishery_vulnerability_plot<-fishery_vulnerability_plot + scale_x_reverse(limits = c(.6, .35))

ggsave(plot = fishery_vulnerability_plot, file = paste0("../figures/vulnerability/fishery_vulnerability.png"))

#using the euclidean distance method
fishery_vulnerability_euc_plot<-ggplot(fishery_summary, aes(x=avg_ac, y=avg_risk_euc)) +
  geom_point() + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") +
  ggtitle("Average vulnerability of fishery participants") +
  geom_text(label = fishery_summary$fishery, nudge_y = .01)
fishery_vulnerability_euc_plot<-fishery_vulnerability_euc_plot + scale_x_reverse(limits = c(.6, .35))
ggsave(plot = fishery_vulnerability_euc_plot, file = paste0("../figures/vulnerability/fishery_vulnerability_euc.png"))
```

##considering average vulnerability based upon region fished
```{r}
#basic risk vs ac plot
region_vulnerability_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk, label = region_summary$region)) +
  geom_point(color = "green") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_plot<-region_vulnerability_plot + scale_x_reverse()
region_vulnerability_plot

ggsave(plot = region_vulnerability_plot, file = paste0("../figures/vulnerability/region_vulnerability.png"))

#plotted with euc method
region_vulnerability_euc_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk_euc, label = region_summary$region)) +
  geom_point(color = "green") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_euc_plot<-region_vulnerability_euc_plot + scale_x_reverse()
region_vulnerability_euc_plot

ggsave(plot = region_vulnerability_euc_plot, file = paste0("../figures/vulnerability/region_vulnerability_euc.png"))
```

##vulnerability with color gradient plot
```{r vulnerability plot}

#first time use full potential range of risk and ac values

# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
riskrange <- seq(0,2, length.out = 100)
acrange <- seq(0,1, length.out = 100)

vulnrange <- expand.grid(x = acrange, y = riskrange)

ranges = data.frame(acrange, riskrange, riskrange - acrange)
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(0,1,length.out=100) # scale of color for x and y,
yColor <- seq(0,2,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor # the color factor for radius - again here should be however you're combining your x and y

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
p1 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk)) +
  xlab("average adaptive capacity") + ylab("average risk") + ggtitle("Fishery vulnerability") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours =rev(cols)) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery) +
  geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))
                                        
#geom_text_repel is if you want labels. If you just want points, you'll need to use something like geom_point(data = FMPmatrix, aes(x = ipsl_exp, y = ipsl_sens))
p1<- p1 + scale_x_reverse()
p1

#I ended up using the a color palette from the scico package because they are color blind #friendly
#devtools::install_github("thomasp85/scico")
#library(scico)
#cols = scico(9, palette = 'roma') #this is kind of a rainbowy palette

#take two
#trying again with ranges set by the highest calculated values instead of the highest potential values

# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
riskrange <- seq(.6,1.6, length.out = 100)
acrange <- seq(0,1, length.out = 100)

vulnrange <- expand.grid(x = acrange, y = riskrange)

ranges = data.frame(acrange, riskrange, riskrange - acrange)
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(.6,1.6,length.out=100) # scale of color for x and y,
yColor <- seq(0,1,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor # the color factor for radius - again here should be however you're combining your x and y

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
p2 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk)) +
  xlab("average adaptive capacity") + ylab("average risk") + ggtitle("Fishery vulnerability") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours =rev(cols)) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery)+
  geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))+
  geom_linerange(fishery_summary, mapping = aes(xmin=avg_ac-ac_sd, xmax=avg_ac+ac_sd, y=avg_risk))
                                        
#geom_text_repel is if you want labels. If you just want points, you'll need to use something like geom_point(data = FMPmatrix, aes(x = ipsl_exp, y = ipsl_sens))
p2<- p2 + scale_x_reverse()
p2

ggsave(plot = p2, file = paste0("../figures/vulnerability/vulnerability_rainbow_sd.png"))
```

##adjusting rainbow plot for vulnerability by euclidean distance
```{r}

#take three
#using full potential range of data

# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
riskrange <- seq(0,1.414, length.out = 100)
acrange <- seq(0,1, length.out = 100)

vulnrange <- expand.grid(x = acrange, y = riskrange)

ranges = data.frame(acrange, riskrange, sqrt(riskrange^2 + acrange^2))
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(0,1,length.out=100) # scale of color for x and y,
yColor <- seq(0,1.414,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor # the color factor for radius - again here should be however you're combining your x and y

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
p3 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk_euc)) +
  xlab("average adaptive capacity") + ylab("average risk") + ggtitle("Fishery vulnerability") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours =rev(cols)) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery)
  #geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))+
  #geom_linerange(fishery_summary, mapping = aes(xmin=avg_ac-ac_sd, xmax=avg_ac+ac_sd, y=avg_risk))
                                        
#geom_text_repel is if you want labels. If you just want points, you'll need to use something like geom_point(data = FMPmatrix, aes(x = ipsl_exp, y = ipsl_sens))
p3<- p3 + scale_x_reverse()
p3

ggsave(plot = p3, file = paste0("../figures/vulnerability/vulnerability_euc_rainbow.png"))
```
##3d plot
```{r}
#not the prettiest but kind of interesting
#install.packages("scatterplot3d")
library("scatterplot3d")
library(PNWColors)
d<-pnw_palette("Sailboat", n=10, type = "continuous")
png("3d vulnerability.png")
vd<-scatterplot3d(x=fishery_summary$avg_exposure, y=fishery_summary$avg_sensitivity, z=(1-fishery_summary$avg_ac),
                  angle = 50,
              main = "Average vulnerabilty of fishery participants",
              xlab = "exposure",
              ylab = "sensitivity",
              zlab = "inverse adpative capacity",
              pch = 18, type = "h",
              color = c(pnw_palette("Sailboat", n=10, type = "continuous"))
)
text(vd$xyz.convert(x=fishery_summary$avg_exposure, y=fishery_summary$avg_sensitivity, z=(1-fishery_summary$avg_ac)), labels = fishery_summary$fishery, cex = .6)
dev.off()
```

##exploring differences in vulnerability and adaptive capacity by groups

##anova of vulnerability for vessel length
```{r}

responses$vessel <- factor(responses$vessel, levels = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"))

responses %>%
  group_by(vessel) %>%
  dplyr::summarise(mean = mean(indv_vulnerability),
                   count = n(),
                   sd = sd(indv_vulnerability)
  )

# Box plots
# Plot weight by group and color by group

vessel_vulnerability<-ggboxplot(responses, x = "vessel", y = "indv_vulnerability",
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "vulnerability", xlab = "vessel length")

ggsave(plot = vessel_vulnerability, file = paste0("../figures/vulnerability/vesselvuln.png"))

#anova
vessel_aov<-aov(indv_vulnerability ~ vessel, data = responses)
summary(vessel_aov)

#repeat but use the euclidean distance calc of vulnerabilty
vessel_eucvulnerability<-ggboxplot(responses, x = "vessel", y = "indv_vulnerability_euc",
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "vulnerability", xlab = "vessel length")

ggsave(plot = vessel_eucvulnerability, file = paste0("../figures/vulnerability/vesselvuln_euc.png"))

#anova
euc_vessel_aov<-aov(indv_vulnerability_euc ~ vessel, data = responses)
summary(euc_vessel_aov)

#tukeys
TukeyHSD(vessel_aov)
TukeyHSD(euc_vessel_aov)
```
##anova for ac by vessel length
```{r}

vessel_ac<-ggboxplot(responses, x = "vessel", y = "indv_ac",
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "adaptive capacity", xlab = "vessel length") +
        theme(plot.title = element_text(size = 22), axis.title = element_text(size = 16), legend.position = "none")
  
vessel_ac

ggsave(plot = vessel_ac, file = paste0("../figures/vulnerability/vesselac.png"))

#anova
ac_vessel_aov<-aov(indv_ac ~ vessel, data = responses)
summary(ac_vessel_aov)

#tukey HSD of anova
ac_vessel_tukey<-TukeyHSD(ac_vessel_aov)
ac_vessel_tukey
```
##how many fisheries are people participating in and how does that affect vulnerability and adpative capacity
```{r}
fishery_particpation<-responses %>%
        select(CPS, dungeness_crab, groundfish, hake, HMS, salmon, scallops, urchin, shrimp, squid, other)

fishery_particpation$num_fisheries = rowSums(fishery_particpation)

responses$num_fisheries = fishery_particpation$num_fisheries

responses <- responses %>% 
  mutate(num_fisheries = case_when(
    num_fisheries == 1 ~ "1",
    num_fisheries == 2 ~ "2",
    num_fisheries == 3 ~ "3",
    num_fisheries == 4 ~ "4+", 
    num_fisheries == 5 ~ "4+",
    num_fisheries == 6 ~ "4+" ))


#summary of vulnerability
responses %>%
  group_by(num_fisheries) %>%
  dplyr::summarise(mean_ex = mean(indv_exposure, na.rm = TRUE),
                   sd_ex = sd(indv_exposure, na.rm = TRUE),
                   mean_sen = mean(indv_sensitivity, na.rm = TRUE),
                   sd_sen = sd(indv_sensitivity, na.rm = TRUE),
                   mean = mean(indv_vulnerability_euc, na.rm = TRUE),
                   sd = sd(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
  )

num_fisheries_vuln_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_vulnerability_euc",
          color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3", "4+"),
          ylab = "average vulnerability", xlab = "number of fisheries participated in")

num_fisheries_vuln_range

ggsave(plot = num_fisheries_vuln_range, file = paste0("../figures/vulnerability/numfisheries_vuln.png"))

#anova
numfisheries_aov<-aov(indv_vulnerability_euc ~ num_fisheries, data = responses)
summary(numfisheries_aov)

#tukey HSD of anova
numfisheries_tukey<-TukeyHSD(numfisheries_aov)
numfisheries_tukey

#summary of adaptive capacity
responses %>%
  group_by(num_fisheries) %>%
  dplyr::summarise(mean = mean(indv_ac, na.rm = TRUE),
                   count = n(),
                   sd = sd(indv_ac, na.rm = TRUE)
  )

num_fisheries_ac_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_ac",
          color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3", "4+"),
          ylab = "adaptive capacity", xlab = "number of fisheries participated in")

num_fisheries_ac_range

ggsave(plot = num_fisheries_ac_range, file = paste0("../figures/vulnerability/numfisheries_ac.png"))

#anova adaptive capacity
numfisheries_ac_aov<-aov(indv_ac ~ num_fisheries, data = responses)
summary(numfisheries_ac_aov)

#tukey HSD of anova
numfisheries_ac_tukey<-TukeyHSD(numfisheries_ac_aov)
numfisheries_ac_tukey

#anova exposure
numfisheries_ex_aov<-aov(indv_exposure ~ num_fisheries, data = responses)
summary(numfisheries_ex_aov)

#tukey HSD of exposure
numfisheries_ex_tukey<-TukeyHSD(numfisheries_ex_aov)
numfisheries_ex_tukey

#anova sensitivity
numfisheries_sen_aov<-aov(indv_sensitivity ~ num_fisheries, data = responses)
summary(numfisheries_sen_aov)
```


##anova for components of vulnerability by age
```{r}

age_ac<-ggboxplot(responses, x = "age", y = "indv_ac",
          color = "age", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U30", "30-40", "40-50", "50-60", "60-70", "70+"),
          ylab = "adaptive capacity", xlab = "age")

ggsave(plot = age_ac, file = paste0("../figures/vulnerability/ageac.png"))

#exposure
ageex_aov<-aov(indv_exposure ~ age, data = responses)
summary(ageex_aov)

#sensitivity
agesen_aov<-aov(indv_sensitivity ~ age, data = responses)
summary(agesen_aov)

#ac
#anova
age_aov<-aov(indv_ac ~ age, data = responses)
summary(age_aov)

#tukey HSD of anova
age_tukey<-TukeyHSD(age_aov)
age_tukey

#vulnerability
agevuln_aov<-aov(indv_vulnerability_euc ~ age, data = responses)
summary(agevuln_aov)
```

##other potential considerations for exposure
##how will climate affect fisheries?
```{r climate impacts on fisheries}

responses$dc_warming<-factor(responses$dc_warming, levels = c("strong_neg", "slight_neg", "no_effect", "slight_pos", "strong_pos", "idk"))

cc_DC_plot <- ggplot(data = responses, aes (x=dc_warming))+
  geom_bar(fill = "blue", position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 16))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Impacts of ocean warming on Dungeness Crab") 

ggsave(plot = cc_DC_plot, file = paste0("../figures/OR_DC/ccimpacts_DC.png"))
```

##Have you seen changes in the range of your primary fishery?
```{r range shifts}
#q27
responses$range_change<-factor(responses$range_change, levels = c("yes", "no"))

rangeshift_plot <- ggplot(data = responses, aes (x=range_change))+
  geom_bar(fill = "blue", position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 16))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Have you seen range shifts in your primary species") 

ggsave(plot = rangeshift_plot, file = paste0("../figures/rangeshift.png"))
```

##have you seen changes in the timing of when you fish?
```{r timing shifts}
#q29
responses$timing_change<-factor(responses$timing_change, levels = c("yes", "no"))

timeshift_plot <- ggplot(data = responses, aes (x=timing_change))+
  geom_bar(fill = "blue", position = position_dodge(), stat="count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 16))+ ylab("Number of Respondents\n")+
  xlab("Category\n")+
  ggtitle("Has the timing of your fishing season changed?") 

ggsave(plot = timeshift_plot, file = paste0("../figures/timeshift.png"))
```
##this section redoes some of the vulnerability calcutions from above using the fishery specific exposure - exposure calculated using only the responses about warming from the fisheries people participate in
##figures saved with fsp in title for fishery specific

##individual vulnerability
```{r vulnerability}
#putting exposure, sensitivity, and ac together

#invidual risk where r = e + s
#not weighted at all
risk<-cbind(responses$fishery_specific_exposure, responses$indv_sensitivity)
responses$indv_risk_fsp = rowSums(risk, na.rm = TRUE)

#starting with v = e + s - ac (Cinner 2012)
#same as v = risk - ac
responses$indv_vulnerability_fsp = responses$indv_risk_fsp - responses$indv_ac

#vulnerability by euclidean distance (Levin and Samhouri 2012)
#risk = sqrt(e^2 + s^2)
#v = sqrt(e^2 + s^2 (1-ac)^2)
responses$risk_euc_fsp = sqrt(responses$fishery_specific_exposure^2 + responses$indv_sensitivity^2)

#Do inverse of adaptive capacity like Davies (2018) where higher number corresponds to lower adaptive capacity
responses$inverse_ac = 1-responses$indv_ac

#for inverse_ac a higher number equals lower adaptive capacity
#use this for euclidean distance for vulnerability

responses$indv_vulnerability_euc_fsp=sqrt(responses$fishery_specific_exposure^2 + responses$indv_sensitivity^2 + responses$inverse_ac^2)

#exploring how the two methods compare
#check risk first
risk_rank_fsp<-rank(responses$indv_risk_fsp, na.last = "keep")
risk_euc_rank_fsp<-rank(responses$risk_euc_fsp, na.last = "keep")
risk_diff_fsp<-risk_rank_fsp-risk_euc_rank_fsp
risk_rankings_fsp<-cbind.data.frame(risk_rank_fsp, risk_euc_rank_fsp, risk_diff_fsp)

#vulnerability differences between methods
vuln_rank_fsp<-rank(responses$indv_vulnerability_fsp, na.last = "keep")
vuln_euc_rank_fsp<-rank(responses$indv_vulnerability_euc_fsp, na.last = "keep")
vuln_diff_fsp<-vuln_rank_fsp-vuln_euc_rank_fsp
vuln_rankings_fsp<-cbind.data.frame(vuln_rank_fsp, vuln_euc_rank_fsp, vuln_diff_fsp)

allrankings<-cbind.data.frame(risk_rank_fsp, risk_euc_rank_fsp, risk_diff_fsp, vuln_rank_fsp, vuln_euc_rank_fsp, vuln_diff_fsp)

#from here down in this chunk not in master if want to add
#save for vulnerability comparisons
write.csv(allrankings, paste0("../data/vulnerability_comparisons.csv"))

#for a small group of individuals, the method makes a big difference

#look at correlation in ranks

all_ranks_fsp<-cbind.data.frame(risk_rank_fsp, risk_euc_rank_fsp, vuln_rank_fsp, vuln_euc_rank_fsp)
rank_cor_fsp<-cor(all_ranks_fsp, use = "complete.obs")
rank_cor_fsp
```

#subseting by fishery
```{r option 2: make a new column and specify fishery(ies) for each person}

# don't need to redo loop
#just redo matrix with average values

fisheryavg_fsp = responses %>%
  group_by(listoffisheries) %>%
  dplyr::summarise(exposure_avg = mean(fishery_specific_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability_fsp, na.rm = TRUE),
                   vuln_euc_avg = mean(indv_vulnerability_euc_fsp, na.rm=TRUE),
                   count = n()
)
```

##average vulnerability by fishery
```{r other ways to subset from Koehn}
#OR if want average across any that contain a single one - 

fisheryavgmatrix_fsp = matrix(NA, nrow = 10, ncol = 10)
colnames(fisheryavgmatrix_fsp) <- c("fishery", "fishery_specific_exposure", "avg_sensitivity", "avg_ac", "ac_sd", "avg_risk_fsp", "risk_sd", "avg_risk_euc_fsp", "avg_vulnerability_fsp", "avg_vulnerabilty_euc_fsp")
fisheryavgmatrix_fsp[,1] = c("CPS", "dungeness crab", "groundfish", "hake", "HMS",
                         "salmon", "scallops","sea urchin", "shrimp", "squid")

#subset to the fishery and avg vulnerability by people who fish for that fishery
for(i in 1:nrow(fisheryavgmatrix_fsp)) {
  index = which(grepl(fisheryavgmatrix_fsp[i,1], responses$listoffisheries) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  fisheryavgmatrix_fsp[i,2] = mean(responses$fishery_specific_exposure[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,5] = sd(responses$indv_ac[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,6] = mean(responses$indv_risk_fsp[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,7] = sd(responses$indv_risk_fsp[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,8] = mean(responses$risk_euc_fsp[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,9] = mean(responses$indv_vulnerability_fsp[index], na.rm = TRUE)
  fisheryavgmatrix_fsp[i,10] = mean(responses$indv_vulnerability_euc_fsp[index], na.rm = TRUE)
}

#change to a dataframe and to numeric
fishery_summary_fsp<-as.data.frame(fisheryavgmatrix_fsp)
fishery_summary_fsp[,2:10]<-sapply(fishery_summary_fsp[,2:10], as.numeric)
```
##average vulnerability by region
##subset by region
```{r Option 1: subset by region fished}

#empty matrix for regional vulnerability numbers
regionmatrix = matrix(NA, nrow = 7, ncol = 6)
colnames(regionmatrix) <- c("region", "avg_exposure", "avg_sensitivity", "avg_ac", "avg_risk", "avg_vulnerability")
regionmatrix[,1] = c("pugetsound_SJF", "wa_coast", "cr", "or_coast", "norcal",
                         "cencal", "socal")

#index essentially placeholder
#change q1r2 for whatever fishery you want to look at
index = which(responses$pugetsound_SJF == 1) #q1r2 is fishing for dungeness crab
# if you changed column names, used the appropriate column name
ps_sjf = responses[index,]

```
#subseting by region
```{r option 2: make a new column and specify regions(s) for each person}

#modifying from fishery code

responses$listofregions = rep(NA, length =  nrow(responses))
# loop through each person and get what they are fishing for, put in new column
# should list each fishery they fish for
# not beautiful code but works
for(i in 1: nrow(responses)) {
  regionname = ""
  if(responses$pugetsound_SJF[i] == 1) {
    regionname = paste(regionname, "Puget Sound SJF", sep = "") 
  }
  if(responses$wa_coast[i] == 1) {
    if(regionname == "") { # have to do extra to not put a , at the beginning
      # if this is the first fishery 
      regionname = paste(regionname, "WA coast", sep = "")
    } else {
      regionname = paste(regionname, "WA coast", sep = ", ")
    }
  }
  if(responses$cr[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "Columbia River", sep = "")
    } else {
      regionname = paste(regionname, "Columbia River", sep = ", ")
    }
  }
  if(responses$or_coast[i] == 1) {
    if(regionname == "") {
    regionname = paste(regionname, "OR coast", sep = "")
    } else {
      regionname = paste(regionname, "OR coast", sep = ", ")
    }
  }
  if(responses$norcal[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "Nor Cal", sep = "")
    } else {
      regionname = paste(regionname, "Nor Cal", sep = ", ")
    }
  }
  if(responses$cencal[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "Cen Cal", sep = "")
    } else {
      regionname = paste(regionname, "Cen Cal", sep = ", ")
    }
  }
  if(responses$socal[i] == 1) {
    if(regionname == "") {
      regionname = paste(regionname, "So Cal", sep = "")
    } else {
      regionname = paste(regionname, "So Cal", sep = ", ")
    }
  }
  responses$listofregions[i] = regionname
}


regionavg = responses %>%
  group_by(listofregions) %>%
  dplyr::summarise(exposure_avg = mean(indv_exposure, na.rm = TRUE),
                   sensitivity_avg = mean(indv_sensitivity, na.rm = TRUE),
                   adaptive_avg = mean(indv_ac),
                   vuln_avg = mean(indv_vulnerability),
                   vuln_euc_avg = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n()
)
```

##average vulnerability by region
```{r}
#grouped by a single regional fishing area
#modify for different surveys

regionmatrix = matrix(NA, nrow = 7, ncol = 8)
colnames(regionmatrix) <- c("region", "avg_exposure", "avg_sensitivity", "avg_ac", "avg_risk", "avg_vulnerability", "avg_risk_euc", "avg_vulnerability_euc")
regionmatrix[,1] = c("Puget Sound SJF", "WA coast", "Columbia River", "OR coast", "Nor Cal",
                         "Cen Cal", "So Cal")

#subset to the fishery and avg vulnerability by people who fish in that area
for(i in 1:nrow(regionmatrix)) {
  index = which(grepl(regionmatrix[i,1], responses$listofregions) == TRUE) 
  #which contain the fishery specified at i, 1 in the matrix
  #so for i = 1, this gives you which rows (which fishermen) fish for CPS
  regionmatrix[i,2] = mean(responses$indv_exposure[index], na.rm = TRUE)
  regionmatrix[i,3] = mean(responses$indv_sensitivity[index], na.rm = TRUE)
  regionmatrix[i,4] = mean(responses$indv_ac[index], na.rm = TRUE)
  regionmatrix[i,5] = mean(responses$indv_risk[index], na.rm = TRUE)
  regionmatrix[i,6] = mean(responses$indv_vulnerability[index], na.rm = TRUE)
  regionmatrix[i,7] = mean(responses$risk_euc[index], na.rm = TRUE)
  regionmatrix[i,8] = mean(responses$indv_vulnerability_euc[index], na.rm = TRUE)
}

#change to a dataframe and to numeric
region_summary<-as.data.frame(regionmatrix)
region_summary[,2:8]<-sapply(region_summary[,2:8], as.numeric)
```
```{r}
#save with vulnerability calculations
write.csv(responses, paste0("../data/PNW_decoded_vulnerability.csv"))
```
##exploratory figures

##visualizing individual risk (exposure v sensitivity)
```{r risk plot}

risk_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity)) +
  geom_point()
risk_plot

ggsave(plot = risk_plot, file = paste0("../figures/risk.png"))

#looking at risk by age
risk_age_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = age)) +
  geom_point()
risk_age_plot

ggsave(plot = risk_age_plot, file = paste0("../figures/risk_age.png"))

#risk by how much income you get from fishing
risk_income_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = income)) +
  geom_point() +
  ggtitle("Risk and percentage of income from outside of fishing")
risk_income_plot

ggsave(plot = risk_income_plot, file = paste0("../figures/risk_income.png"))

#risk by state
risk_state_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, color = state_code)) +
  geom_point() +
  ggtitle("Risk and state of residence")
risk_state_plot

ggsave(plot = risk_state_plot, file = paste0("../figures/vulnerability/risk_state.png"))

#basic risk vs ac plot by region
region_vulnerability_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk, label = region_summary$region)) +
  geom_point(color = "green") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_plot<-region_vulnerability_plot + scale_x_reverse()

region_vulnerability_plot

ggsave(plot = region_vulnerability_plot, file = paste0("../figures/vulnerability/region_vulnerability.png"))
```

##considering average vulnerability based upon fishery participation
```{r vulnerability}

#basic risk vs ac
fishery_vulnerability_plot_fsp<-ggplot(fishery_summary_fsp, aes(x=avg_ac, y=avg_risk_fsp)) +
  geom_point() + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") +
  ggtitle("Average vulnerability of fishery participants") +
  geom_text(label = fishery_summary_fsp$fishery, nudge_y = .01)
fishery_vulnerability_plot_fsp<-fishery_vulnerability_plot_fsp + scale_x_reverse(limits = c(.6, .35))

ggsave(plot = fishery_vulnerability_plot_fsp, file = paste0("../figures/vulnerability/fishery_vulnerability_fsp.png"))

#using the euclidean distance method
fishery_vulnerability_euc_plot_fsp<-ggplot(fishery_summary_fsp, aes(x=avg_ac, y=avg_risk_euc_fsp)) +
  geom_point() + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") +
  ggtitle("Average vulnerability of fishery participants") +
  geom_text(label = fishery_summary_fsp$fishery, nudge_y = .01)
fishery_vulnerability_euc_plot_fsp<-fishery_vulnerability_euc_plot_fsp + scale_x_reverse(limits = c(.6, .35))
ggsave(plot = fishery_vulnerability_euc_plot_fsp, file = paste0("../figures/vulnerability/fishery_vulnerability_euc_fsp.png"))
```

##considering average vulnerability based upon region fished
```{r}
#basic risk vs ac plot
region_vulnerability_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk, label = region_summary$region)) +
  geom_point(color = "green") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_plot<-region_vulnerability_plot + scale_x_reverse()
region_vulnerability_plot

ggsave(plot = region_vulnerability_plot, file = paste0("../figures/vulnerability/region_vulnerability.png"))

#plotted with euc method
region_vulnerability_euc_plot<-ggplot(region_summary, aes(x=avg_ac, y=avg_risk_euc, label = region_summary$region)) +
  geom_point(color = "green") + xlab("Average Adaptive Capacity") +
  ylab("Average Risk") + 
  ggtitle("Average vulnerability of fishing regions") +
  geom_text_repel()
region_vulnerability_euc_plot<-region_vulnerability_euc_plot + scale_x_reverse()
region_vulnerability_euc_plot

ggsave(plot = region_vulnerability_euc_plot, file = paste0("../figures/vulnerability/region_vulnerability_euc.png"))
```

##vulnerability with color gradient plot
```{r vulnerability plot}

#first time use full potential range of risk and ac values

# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
riskrange <- seq(0,2, length.out = 100)
acrange <- seq(0,1, length.out = 100)

vulnrange <- expand.grid(x = acrange, y = riskrange)

ranges = data.frame(acrange, riskrange, riskrange - acrange)
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(0,1,length.out=100) # scale of color for x and y,
yColor <- seq(0,2,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor # the color factor for radius - again here should be however you're combining your x and y

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
p1 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk)) +
  xlab("average adaptive capacity") + ylab("average risk") + ggtitle("Fishery vulnerability") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours =rev(cols)) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery) +
  geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))
                                        
#geom_text_repel is if you want labels. If you just want points, you'll need to use something like geom_point(data = FMPmatrix, aes(x = ipsl_exp, y = ipsl_sens))
p1<- p1 + scale_x_reverse()
p1

#I ended up using the a color palette from the scico package because they are color blind #friendly
#devtools::install_github("thomasp85/scico")
#library(scico)
#cols = scico(9, palette = 'roma') #this is kind of a rainbowy palette

#take two
#trying again with ranges set by the highest calculated values instead of the highest potential values

# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
riskrange <- seq(.6,1.6, length.out = 100)
acrange <- seq(0,1, length.out = 100)

vulnrange <- expand.grid(x = acrange, y = riskrange)

ranges = data.frame(acrange, riskrange, riskrange - acrange)
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(.6,1.6,length.out=100) # scale of color for x and y,
yColor <- seq(0,1,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor # the color factor for radius - again here should be however you're combining your x and y

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
p2 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk)) +
  xlab("average adaptive capacity") + ylab("average risk") + ggtitle("Fishery vulnerability") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours =rev(cols)) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery)+
  geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))+
  geom_linerange(fishery_summary, mapping = aes(xmin=avg_ac-ac_sd, xmax=avg_ac+ac_sd, y=avg_risk))
                                        
#geom_text_repel is if you want labels. If you just want points, you'll need to use something like geom_point(data = FMPmatrix, aes(x = ipsl_exp, y = ipsl_sens))
p2<- p2 + scale_x_reverse()
p2

ggsave(plot = p2, file = paste0("../figures/vulnerability/vulnerability_rainbow_sd.png"))
```

##adjusting rainbow plot for vulnerability by euclidean distance
```{r}

#take three
#using full potential range of data

# you set the ranges for your X and Y axes
# this makes vectors of values from your min x or y to your max x or y
riskrange <- seq(0,1.414, length.out = 100)
acrange <- seq(0,1, length.out = 100)

vulnrange <- expand.grid(x = acrange, y = riskrange)

ranges = data.frame(acrange, riskrange, sqrt(riskrange^2 + acrange^2))
# the last part (the sqrt part) needs to be whatever you calculation of risk is - i.e. how are you combining your x and y
colnames(ranges) = c("x", "y", "z")
xColor <- seq(0,1,length.out=100) # scale of color for x and y,
yColor <- seq(0,1.414,length.out=100)

df <- cbind(expand.grid(x=xColor, y=yColor), expand.grid(x=acrange, y=riskrange)) #grid for colors
colnames(df)<-c("xColor","yColor","x2","y2")
df$vuln <- df$yColor - df$xColor # the color factor for radius - again here should be however you're combining your x and y

cols = brewer.pal(9, "Spectral") # or whatever color palette you want to use
#FMPmatrix = data.frame(fishery_summary) # this was my species risk data so just make sure your data is in a data frame

#this works with full potential range of risk and ac
# plotting - key thing here is sometimes you are calling your data frame (mine is "FMPmatrix") and sometimes your #calling the data frame of colors ("df")
p3 <- ggplot(fishery_summary, aes(x = avg_ac, y = avg_risk_euc)) +
  xlab("average adaptive capacity") + ylab("average risk") + ggtitle("Fishery vulnerability") +
  geom_raster(data =df, aes(x = x2, y = y2, fill = vuln))+
  scale_fill_gradientn(colours =rev(cols)) +
  geom_point()+
  geom_text_repel(label = fishery_summary$fishery)
  #geom_linerange(fishery_summary, mapping = aes(x=avg_ac, ymin=avg_risk-risk_sd, ymax=avg_risk+risk_sd))+
  #geom_linerange(fishery_summary, mapping = aes(xmin=avg_ac-ac_sd, xmax=avg_ac+ac_sd, y=avg_risk))
                                        
#geom_text_repel is if you want labels. If you just want points, you'll need to use something like geom_point(data = FMPmatrix, aes(x = ipsl_exp, y = ipsl_sens))
p3<- p3 + scale_x_reverse()
p3

ggsave(plot = p3, file = paste0("../figures/vulnerability/vulnerability_euc_rainbow.png"))
```
##3d plot
```{r}
#not the prettiest but kind of interesting
#install.packages("scatterplot3d")
library("scatterplot3d")
library(PNWColors)
d<-pnw_palette("Sailboat", n=10, type = "continuous")
png("3d vulnerability.png")
vd<-scatterplot3d(x=fishery_summary$avg_exposure, y=fishery_summary$avg_sensitivity, z=(1-fishery_summary$avg_ac),
                  angle = 50,
              main = "Average vulnerabilty of fishery participants",
              xlab = "exposure",
              ylab = "sensitivity",
              zlab = "inverse adpative capacity",
              pch = 18, type = "h",
              color = c(pnw_palette("Sailboat", n=10, type = "continuous"))
)
text(vd$xyz.convert(x=fishery_summary$avg_exposure, y=fishery_summary$avg_sensitivity, z=(1-fishery_summary$avg_ac)), labels = fishery_summary$fishery, cex = .6)
dev.off()
```

##exploring differences in vulnerability and adaptive capacity by groups

##anova of vulnerability for vessel length
```{r}

responses$vessel <- factor(responses$vessel, levels = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"))

responses %>%
  group_by(vessel) %>%
  dplyr::summarise(mean = mean(indv_vulnerability),
                   count = n(),
                   sd = sd(indv_vulnerability)
  )

# Box plots
# Plot weight by group and color by group

vessel_vulnerability<-ggboxplot(responses, x = "vessel", y = "indv_vulnerability",
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "vulnerability", xlab = "vessel length")

ggsave(plot = crab_vessel_vulnerability, file = paste0("../figures/vulnerability/vesselvuln.png"))

#anova
vessel_aov<-aov(indv_vulnerability ~ vessel, data = responses)
summary(vessel_aov)

#repeat but use the euclidean distance calc of vulnerabilty
vessel_eucvulnerability<-ggboxplot(responses, x = "vessel", y = "indv_vulnerability_euc",
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "vulnerability", xlab = "vessel length")

ggsave(plot = crab_vessel_eucvulnerability, file = paste0("../figures/vulnerability/vesselvuln_euc.png"))

#anova
euc_vessel_aov<-aov(indv_vulnerability_euc ~ vessel, data = responses)
summary(euc_vessel_aov)

#tukeys
TukeyHSD(vessel_aov)
TukeyHSD(euc_vessel_aov)
```
##anova for ac by vessel length
```{r}

vessel_ac<-ggboxplot(responses, x = "vessel", y = "indv_ac",
          color = "vessel", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("U25", "26-35", "36-45", "46-55", "56-65", "66+"),
          ylab = "adaptive capacity", xlab = "vessel length") +
        theme(plot.title = element_text(size = 22), axis.title = element_text(size = 16), legend.position = "none")
  
vessel_ac

ggsave(plot = vessel_ac, file = paste0("../figures/vulnerability/vesselac.png"))

#anova
ac_vessel_aov<-aov(indv_ac ~ vessel, data = responses)
summary(ac_vessel_aov)

#tukey HSD of anova
ac_vessel_tukey<-TukeyHSD(ac_vessel_aov)
ac_vessel_tukey
```
##how many fisheries are people participating in and how does that affect vulnerability and adpative capacity
```{r}
fishery_particpation<-responses %>%
        select(CPS, dungeness_crab, groundfish, hake, HMS, salmon, scallops, urchin, shrimp, squid, other)

fishery_particpation$num_fisheries = rowSums(fishery_particpation)

responses$num_fisheries = fishery_particpation$num_fisheries

responses <- responses %>% 
  mutate(num_fisheries = case_when(
    num_fisheries == 1 ~ "1",
    num_fisheries == 2 ~ "2",
    num_fisheries == 3 ~ "3",
    num_fisheries == 4 ~ "4+", 
    num_fisheries == 5 ~ "4+",
    num_fisheries == 6 ~ "4+" ))


#summary of vulnerability
responses %>%
  group_by(num_fisheries) %>%
  dplyr::summarise(mean = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n(),
                   sd = sd(indv_vulnerability_euc, na.rm = TRUE)
  )

num_fisheries_vuln_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_vulnerability_euc",
          color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3", "4+"),
          ylab = "average vulnerability", xlab = "number of fisheries participated in")

num_fisheries_vuln_range

ggsave(plot = num_fisheries_vuln_range, file = paste0("../figures/vulnerability/numfisheries_vuln.png"))

#anova
numfisheries_aov<-aov(indv_vulnerability_euc ~ num_fisheries, data = responses)
summary(numfisheries_aov)

#tukey HSD of anova
numfisheries_tukey<-TukeyHSD(numfisheries_aov)
numfisheries_tukey

#summary of adaptive capacity
responses %>%
  group_by(num_fisheries) %>%
  dplyr::summarise(mean = mean(indv_ac, na.rm = TRUE),
                   count = n(),
                   sd = sd(indv_ac, na.rm = TRUE)
  )

num_fisheries_ac_range<-ggboxplot(responses, x = "num_fisheries", y = "indv_ac",
          color = "num_fisheries", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#00AFBB", "#E7B800", "#FC4E07"),
          order = c("1", "2", "3", "4+"),
          ylab = "adaptive capacity", xlab = "number of fisheries participated in")

num_fisheries_ac_range

ggsave(plot = num_fisheries_ac_range, file = paste0("../figures/vulnerability/numfisheries_ac.png"))

#anova
numfisheries_ac_aov<-aov(indv_ac ~ num_fisheries, data = responses)
summary(numfisheries_ac_aov)

#tukey HSD of anova
numfisheries_ac_tukey<-TukeyHSD(numfisheries_ac_aov)
numfisheries_ac_tukey
```
##varibility in vulnerability depending on if you think climate change is happening or not
```{r}
responses$believecat = responses$believe

responses <- responses %>% 
  mutate(believecat = case_when(
    believecat == "strongly_agree" ~ "agree",
    believecat == "somewhat_agree" ~ "agree",
    believecat == "neutral" ~ "neutral",
    believecat == "somewhat_disagree" ~ "disagree", 
    believecat == "strongly_disagree" ~ "disagree"))

#components of vulnerability and belief in climate change
responses %>%
  group_by(believecat) %>%
  dplyr::summarise(meanex = mean(indv_exposure, na.rm = TRUE),
                   meansen = mean(indv_sensitivity, na.rm = TRUE),
                   meanac = mean(indv_ac, na.rm = TRUE),
                   meanvuln = mean(indv_vulnerability_euc, na.rm = TRUE),
                   count = n())

belief_vuln<-ggboxplot(responses, x = "believecat", y = "indv_vulnerability_euc",
          color = "believecat", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          order = c("disagree", "neutral", "agree"),
          ylab = "vulnerability", xlab = "I believe climate change is occuring")

ggsave(plot = belief_vuln, file = paste0("../figures/vulnerability/belief_vuln.png"))

#anova
beliefvuln_aov<-aov(indv_vulnerability_euc ~ believecat, data = responses)
summary(beliefvuln_aov)

#tukey HSD of vulnerability
beliefvuln_tukey<-TukeyHSD(beliefvuln_aov)
beliefvuln_tukey

#agree and neutral differnt from disagree but not from each other but close for vulnerability

#anova exposure
beliefex_aov<-aov(indv_exposure ~ believecat, data = responses)
summary(beliefex_aov)

#tukey HSD of exposure
beliefex_tukey<-TukeyHSD(beliefex_aov)
beliefex_tukey
#agree different than both, neutal and disagree not different

#anova of sensitivity
beliefsen_aov<-aov(indv_sensitivity ~ believecat, data = responses)
summary(beliefsen_aov)

#tukey HSD of sensitivity
beliefsen_tukey<-TukeyHSD(beliefsen_aov)
beliefsen_tukey
#neutral and agree the same, both different than disagree

#anova of adaptive capacity
beliefac_aov<-aov(indv_ac ~ believecat, data = responses)
summary(beliefac_aov)

#tukey HSD of vulnerability
beliefac_tukey<-TukeyHSD(beliefac_aov)
beliefac_tukey
```

##scatterplot of vulnerability depending on your belief in climate change
```{r vulnerability}
responses <- read.csv("../data/PNW_decoded_vulnerability.csv")

#basic risk vs ac
belief_plot<-ggplot(responses, aes(x=indv_exposure, y=indv_sensitivity, group = believecat, color = believecat)) +
  geom_point(size = 4, alpha = .8) + xlab("Exposure") + scale_color_manual(values = pal) +
  ylab("Sensitivity") +
  ggtitle("Risk and belief in climate change") +
  theme(plot.title = element_text(size = 22), axis.title = element_text(size = 16), legend.text = element_text(size = 12))
belief_plot

ggsave(plot = belief_plot, file = paste0("../figures/vulnerability/belief_vulnerability.png"))

#testing the differences between the slopes
install.packages("lsmeans")
library(lsmeans)

agree<- lm(risk_euc~indv_ac, data = responses,
           subset = believecat =="agree")
agree

bv<-lm(risk_euc~inverse_ac*believecat, data = responses)
bv
anova(bv)

bvslopes<-lstrends(bv, "believecat", var="inverse_ac")
bvslopes

pairs(bvslopes)

install.packages("ggally")
library(ggally)
```
```{r}
# Libraries
library(hrbrthemes)
library(GGally)
library(viridis)

beliefs_vuln<-responses %>%
        select(indv_exposure, indv_sensitivity, indv_ac, indv_vulnerability_euc, believecat)
beliefs_vuln$believecat<-as.factor(beliefs_vuln$believecat)

#try with my data
ggparcoord(beliefs_vuln,
    columns = 1:4, groupColumn = 5, order = "anyClass",
    showPoints = TRUE, 
    title = "Components of vulnerability and belief in climate change",
    alphaLines = 0.3
    ) + 
  scale_color_viridis(discrete=TRUE) +
  theme_ipsum()+
  theme(
    plot.title = element_text(size=10)
  )

ggparcoord(beliefs_vuln,
    columns = 1:4, groupColumn = 5,
    scale = "globalminmax",
    showPoints = TRUE,
    title = "Components of vulnerability and belief in climate change",
    alphaLines = 0.3) +
  scale_color_viridis(discrete = TRUE)


beliefs_vuln %>%
  arrange(desc(believecat)) %>%
  ggparcoord(
    columns = 1:4, groupColumn = 5,
    showPoints = TRUE, 
    title = "Original",
    alphaLines = 1
    ) + 
   scale_color_viridis(discrete = TRUE) +
  theme_ipsum()+
  theme(
    legend.position="Default",
    plot.title = element_text(size=10)
  ) +
  xlab("")

data %>%
  arrange(desc(Species)) %>%
  ggparcoord(
    columns = 1:4, groupColumn = 5, order = "anyClass",
    showPoints = TRUE, 
    title = "Original",
    alphaLines = 1
    ) + 
  scale_color_manual(values=c( "#69b3a2", "#E8E8E8", "#E8E8E8") ) +
  theme_ipsum()+
  theme(
    legend.position="Default",
    plot.title = element_text(size=10)
  ) +
  xlab("")
```

#more vulnerability plots for tnc talk
```{r}
mv<-mean(responses$indv_vulnerability_euc, na.rm = TRUE)

mv

hal<-pnw_palette("Bay", 1)

#density plot of individual vulnerability
fu<-ggplot(responses, aes(x=indv_vulnerability_euc))+
  geom_density(fill =hal, alpha = .8) + 
  xlab("vulnerability") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1.75)) + 
  ggtitle("Distribution of perceived vulnerability")+ 
  theme(plot.title = element_text(size = 22), axis.title.x = element_text(size = 16))
fu

ggsave(plot = fu, height = 7, width = 10, file = paste0("../figures/vulnerability/vuln_distribution.png"))

pal<-pnw_palette("Bay",3)
pu<-ggplot(responses, aes(x = indv_vulnerability_euc, group = believecat, fill = believecat))+
             geom_density(alpha = .6)+
  scale_fill_manual(values = pal) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 3)) +
    ggtitle("Distribution of perceived vulnerability")+ 
  theme(plot.title = element_text(size = 22), axis.title.x = element_text(size = 16), legend.text = element_text(size = 12)) +
  xlab("vulnerability")
pu

ggsave(plot = pu, height = 7, width = 10, file = paste0("../figures/vulnerability/belief_distribution.png"))

```

##save with vulnerability calculations for seperate code looking at individual fisheries
```{r}
#save with vulnerability calculations
write.csv(responses, paste0("../data/PNW_decoded_vulnerability.csv"))
```

#from initial explorations, need to revisit and fix or delete
#plot risk against inverse of ac
#indv_vulnerability_plot<-ggplot(responses, aes(x=(1 - indv_ac), y=indv_risk, color = state_code)) +
  #geom_point() +
  #ggtitle("Vulnerability and state of residence")
#indv_vulnerability_plot

#ggsave(plot = indv_vulnerability_plot, file = #paste0("../figures/vulnerability/vulnerability_state.png"))

#vulnerability if you use euclidean distance to find risk
#v = sqrt(e^2 + s^2 + ac^2)
#responses$indv_vulnerability_euc<-sqrt(responses$indv_exposure^2 + responses$indv_sensitivity^2)
#vulnerability_euc_plot<-ggplot(responses, aes(x=(1 - indv_ac_pctrank), y=indv_risk_euc, color = state_code)) +
  #geom_point() +
  #ggtitle("Vulnerability using euclidean distance for risk")
#vulnerability_euc_plot

#ggsave(plot = vulnerability_euc_plot, file = paste0("../figures/vulnerability/vulnerability_euc.png"))

#exploring how the two risk methods compare
#risk_rank<-rank(responses$indv_risk)
#risk_euc_rank<-rank(responses$indv_risk_euc)
#risk_diff<-risk_pct_rank-risk_euc_rank
#risk_rankings<-cbind.data.frame(risk_rank, risk_pct_rank, risk_euc_rank, risk_diff)
